#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÐºÐ°Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°
# ÐžÐ±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹

echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÐºÐ°Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root: sudo $0"
    exit 1
fi

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿ÑƒÑ‚Ð¸ Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
PROJECT_PATH="/var/www/prohelper"
if [ ! -d "$PROJECT_PATH" ]; then
    echo "âŒ ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² $PROJECT_PATH"
    echo "Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ¸Ð¼Ð»Ð¸Ð½Ðº:"
    echo "sudo ln -s $(pwd) $PROJECT_PATH"
    exit 1
fi

echo "ðŸ“ ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð²: $PROJECT_PATH"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
cat > /etc/systemd/system/monitoring.service << EOF
[Unit]
Description=Laravel Monitoring Stack (Prometheus, Grafana, Loki)
Requires=docker.service
After=docker.service
Wants=network-online.target
After=network-online.target

[Service]
Type=forking
User=root
Group=root
WorkingDirectory=$PROJECT_PATH
ExecStartPre=/bin/bash -c 'mkdir -p storage/logs/{api,telemetry} && chmod -R 777 storage/logs/'
ExecStart=/bin/bash $PROJECT_PATH/start-monitoring.sh
ExecStop=/bin/bash $PROJECT_PATH/stop-monitoring.sh
ExecReload=/bin/bash -c 'cd $PROJECT_PATH && docker-compose restart'
Restart=always
RestartSec=10
TimeoutStartSec=300
TimeoutStopSec=120

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
Environment=COMPOSE_PROJECT_NAME=monitoring
Environment=DOCKER_BUILDKIT=1

# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
StandardOutput=journal
StandardError=journal
SyslogIdentifier=monitoring

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=$PROJECT_PATH
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ
echo "ðŸ¥ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ..."
cat > $PROJECT_PATH/monitoring-health-check.sh << 'EOF'
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· cron ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚

LOG_FILE="/var/log/monitoring-health.log"
PROJECT_PATH="/var/www/prohelper"
ALERT_WEBHOOK_URL=""  # Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ URL Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (Slack/Telegram)

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð°Ð»ÐµÑ€Ñ‚Ð¾Ð²
send_alert() {
    local message="$1"
    log_message "ALERT: $message"
    
    if [ -n "$ALERT_WEBHOOK_URL" ]; then
        curl -s -X POST "$ALERT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"ðŸš¨ Monitoring Alert: $message\"}" || true
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
check_containers() {
    cd "$PROJECT_PATH" || exit 1
    
    local containers=("prometheus" "grafana" "loki" "node-exporter")
    local failed_containers=()
    
    for container in "${containers[@]}"; do
        if ! docker ps --format "table {{.Names}}" | grep -q "^$container$"; then
            failed_containers+=("$container")
        fi
    done
    
    if [ ${#failed_containers[@]} -gt 0 ]; then
        send_alert "ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹: ${failed_containers[*]}"
        log_message "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°..."
        ./start-monitoring.sh
        sleep 60
        return 1
    fi
    
    return 0
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° HTTP ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ð¾Ð²
check_endpoints() {
    local endpoints=(
        "http://localhost:9090/-/healthy:Prometheus"
        "http://localhost:3000/api/health:Grafana"
        "http://localhost:3100/ready:Loki"
        "http://localhost:9100/metrics:Node-Exporter"
    )
    
    local failed_endpoints=()
    
    for endpoint_info in "${endpoints[@]}"; do
        local url="${endpoint_info%:*}"
        local name="${endpoint_info#*:}"
        
        if ! curl -sf "$url" >/dev/null 2>&1; then
            failed_endpoints+=("$name")
        fi
    done
    
    if [ ${#failed_endpoints[@]} -gt 0 ]; then
        send_alert "Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹: ${failed_endpoints[*]}"
        return 1
    fi
    
    return 0
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
check_resources() {
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð¸ÑÐºÐ°
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ "$disk_usage" -gt 90 ]; then
        send_alert "ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¼Ð°Ð»Ð¾ Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ: ${disk_usage}%"
    elif [ "$disk_usage" -gt 80 ]; then
        log_message "WARN: ÐœÐ°Ð»Ð¾ Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ: ${disk_usage}%"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ð¼ÑÑ‚Ð¸
    local mem_usage=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
    if [ "$mem_usage" -gt 90 ]; then
        send_alert "ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸: ${mem_usage}%"
    fi
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°
main() {
    log_message "ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°"
    
    local issues=0
    
    if ! check_containers; then
        issues=$((issues + 1))
    fi
    
    if ! check_endpoints; then
        issues=$((issues + 1))
    fi
    
    check_resources
    
    if [ $issues -eq 0 ]; then
        log_message "Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾"
    else
        log_message "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼: $issues"
    fi
    
    log_message "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
}

# Ð—Ð°Ð¿ÑƒÑÐº
main "$@"
EOF

chmod +x $PROJECT_PATH/monitoring-health-check.sh

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ cron Ð·Ð°Ð´Ð°Ñ‡
echo "â° ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cron Ð·Ð°Ð´Ð°Ñ‡..."
cat > /tmp/monitoring-cron << EOF
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚
*/5 * * * * $PROJECT_PATH/monitoring-health-check.sh

# Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 2:00
0 2 * * * find $PROJECT_PATH/storage/logs -name "*.log" -mtime +7 -delete

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Docker ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00
0 3 * * 0 docker system prune -f --volumes

# Ð‘ÑÐºÐ°Ð¿ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 1:00
0 1 * * * tar -czf /tmp/monitoring-backup-\$(date +\%Y\%m\%d).tar.gz -C $PROJECT_PATH monitoring/ docker-compose.yml

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð² (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
0 4 * * * find /tmp -name "monitoring-backup-*.tar.gz" -mtime +30 -delete
EOF

crontab /tmp/monitoring-cron
rm /tmp/monitoring-cron

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p /var/log
touch /var/log/monitoring-health.log
chmod 644 /var/log/monitoring-health.log

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd..."
systemctl daemon-reload

# Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "âœ… Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
systemctl enable monitoring

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°..."
systemctl start monitoring

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°..."
sleep 10
systemctl status monitoring --no-pager

echo ""
echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼:"
echo "   systemctl status monitoring    # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ"
echo "   systemctl start monitoring     # Ð—Ð°Ð¿ÑƒÑÐº"
echo "   systemctl stop monitoring      # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
echo "   systemctl restart monitoring   # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
echo "   journalctl -u monitoring -f    # Ð›Ð¾Ð³Ð¸"
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ:"
echo "   $PROJECT_PATH/monitoring-health-check.sh"
echo "   tail -f /var/log/monitoring-health.log"
echo ""
echo "ðŸ“Š Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹:"
echo "   Grafana:    http://localhost:3000 (admin/admin123)"
echo "   Prometheus: http://localhost:9090"
echo "   Loki:       http://localhost:3100"
echo ""
echo "âš ï¸  ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ:"
echo "   1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ firewall Ð´Ð»Ñ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² 3000, 3100, 9090, 9100"
echo "   2. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð² Grafana"
echo "   3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ ALERT_WEBHOOK_URL Ð² monitoring-health-check.sh"
echo "   4. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº storage/logs/"