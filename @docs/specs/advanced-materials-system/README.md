# Спецификация: Расширенная система материалов и активов

## Цель
Расширение системы материалов для полноценного учета всех типов активов на строительной площадке: от стройматериалов до оборудования, мебели и инструментов.

## Проблематика
Текущая система материалов имеет примитивную категоризацию (простое текстовое поле) и ориентирована только на стройматериалы. На реальной стройке присутствуют:

- Строительные материалы (цемент, кирпич, арматура)
- Оборудование и техника (бетономешалки, подъемники, генераторы)
- Мебель и предметы интерьера (стулья, столы, шкафы)
- Инструменты и оснастка (электроинструмент, ручной инструмент)
- Расходные материалы (смазки, крепеж, химия)
- Специализированное оборудование (лесов, опалубки, временные конструкции)

## Требования

### Функциональные требования

#### 1. Иерархическая категоризация
- **Тип актива** (Material/Equipment/Tool/Consumable/Furniture)
- **Категория** (строительные материалы, оборудование, мебель и т.д.)
- **Подкатегория** (цемент, кирпич, арматура и т.д.)
- **Атрибуты учета** (серийные номера, сроки службы, амортизация)

#### 2. Расширенные атрибуты
- **Физические характеристики** (размеры, вес, объем)
- **Технические параметры** (мощность, напряжение, производительность)
- **Бухгалтерские атрибуты** (счет учета, амортизационная группа)
- **Логистические данные** (габариты для транспортировки)

#### 3. Жизненный цикл активов
- **Поступление** (покупка/аренда/перемещение)
- **Эксплуатация** (амортизация, обслуживание, ремонт)
- **Выбытие** (продажа/списание/утилизация)

#### 4. Специфические режимы учета
- **Серийный учет** для оборудования
- **Партионный учет** для материалов
- **Учет по срокам службы** для инструментов
- **Амортизационный учет** для основных средств

### Нефункциональные требования

#### Производительность
- Поддержка 100,000+ позиций в каталоге
- Быстрый поиск по множественным критериям
- Оптимизированные запросы для аналитики

#### Интеграция
- Интеграция с существующими отчетами
- Совместимость с AI Assistant
- Поддержка импорта/экспорта

#### Масштабируемость
- Гибкая система атрибутов
- Возможность добавления новых типов активов
- Независимые подсистемы учета

## Архитектура решения

### Модель данных

#### AssetType (Тип актива)
```php
enum AssetType: string {
    case MATERIAL = 'material';        // Материалы
    case EQUIPMENT = 'equipment';      // Оборудование
    case TOOL = 'tool';               // Инструмент
    case CONSUMABLE = 'consumable';    // Расходники
    case FURNITURE = 'furniture';      // Мебель
    case STRUCTURE = 'structure';      // Временные конструкции
}
```

#### AssetCategory (Категория)
```php
enum AssetCategory: string {
    // Материалы
    case CONSTRUCTION = 'construction_materials';
    case FINISHING = 'finishing_materials';

    // Оборудование
    case HEAVY_MACHINERY = 'heavy_machinery';
    case POWER_TOOLS = 'power_tools';
    case SAFETY_EQUIPMENT = 'safety_equipment';

    // И т.д.
}
```

#### Asset (Основная модель - расширение Material)
```php
class Asset extends Material {
    // Наследуемые поля
    protected $fillable = [
        // ... существующие поля Material
        'asset_type',           // Тип актива
        'asset_category',       // Категория
        'asset_subcategory',    // Подкатегория

        // Расширенные атрибуты
        'serial_number',        // Серийный номер
        'batch_number',         // Номер партии
        'manufacture_date',     // Дата производства
        'warranty_period',      // Гарантийный срок
        'service_life',         // Срок службы

        // Физические характеристики
        'dimensions',           // Габариты (JSON)
        'weight',              // Вес
        'volume',              // Объем

        // Технические параметры
        'specifications',      // Спецификации (JSON)
        'power_consumption',   // Энергопотребление
        'operating_voltage',   // Рабочее напряжение

        // Бухгалтерские атрибуты
        'depreciation_group',  // Амортизационная группа
        'depreciation_rate',   // Норма амортизации
        'residual_value',      // Остаточная стоимость

        // Статусы
        'asset_status',        // Статус актива
        'location',            // Местоположение
        'assigned_to',         // Кому присвоено
    ];
}
```

### Специализированные модели

#### Equipment (Оборудование)
```php
class Equipment extends Asset {
    protected $fillable = [
        // ... базовые поля Asset
        'equipment_type',       // Тип оборудования
        'model',               // Модель
        'manufacturer',        // Производитель
        'maintenance_schedule', // График обслуживания
        'last_maintenance',    // Последнее обслуживание
        'next_maintenance',    // Следующее обслуживание
    ];
}
```

#### Tool (Инструмент)
```php
class Tool extends Asset {
    protected $fillable = [
        // ... базовые поля Asset
        'tool_type',           // Тип инструмента
        'calibration_date',    // Дата калибровки
        'calibration_due',     // Срок следующей калибровки
        'usage_counter',       // Счетчик использования
    ];
}
```

### Система атрибутов

#### DynamicAttribute (Динамические атрибуты)
```php
class DynamicAttribute {
    protected $fillable = [
        'asset_type',          // Тип актива
        'attribute_name',      // Название атрибута
        'attribute_type',      // Тип данных (string/number/date/json)
        'is_required',         // Обязательный
        'default_value',       // Значение по умолчанию
        'validation_rules',    // Правила валидации
    ];
}
```

#### AssetAttributeValue (Значения атрибутов)
```php
class AssetAttributeValue {
    protected $fillable = [
        'asset_id',            // ID актива
        'attribute_id',        // ID атрибута
        'value',              // Значение
    ];
}
```

## API и интерфейсы

### REST API Endpoints

#### Каталоги
```
GET    /api/v1/admin/assets/types              - Список типов активов
GET    /api/v1/admin/assets/categories         - Список категорий
POST   /api/v1/admin/assets/categories         - Создание категории
PUT    /api/v1/admin/assets/categories/{id}    - Обновление категории
DELETE /api/v1/admin/assets/categories/{id}    - Удаление категории
```

#### Управление активами
```
GET    /api/v1/admin/assets                    - Список активов
POST   /api/v1/admin/assets                    - Создание актива
GET    /api/v1/admin/assets/{id}               - Детали актива
PUT    /api/v1/admin/assets/{id}               - Обновление актива
DELETE /api/v1/admin/assets/{id}              - Удаление актива
```

#### Специализированные операции
```
POST   /api/v1/admin/assets/{id}/maintenance   - Запись обслуживания
POST   /api/v1/admin/assets/{id}/transfer      - Перемещение актива
POST   /api/v1/admin/assets/{id}/decommission  - Списание актива
GET    /api/v1/admin/assets/{id}/history       - История операций
```

#### Складские операции
```
# Управление складами
GET    /api/v1/admin/warehouses               - Список складов
POST   /api/v1/admin/warehouses               - Создание склада
PUT    /api/v1/admin/warehouses/{id}          - Обновление склада
DELETE /api/v1/admin/warehouses/{id}          - Удаление склада

# Перемещения активов
POST   /api/v1/admin/assets/{id}/transfer     - Перемещение актива
GET    /api/v1/admin/transfers                - История перемещений

# Резервирование активов
POST   /api/v1/admin/assets/{id}/reserve      - Резервирование
POST   /api/v1/admin/assets/{id}/unreserve    - Снятие резерва
GET    /api/v1/admin/reservations             - Активные резервы

# Инвентаризация
POST   /api/v1/admin/inventory/acts           - Создание акта инвентаризации
GET    /api/v1/admin/inventory/acts           - Список актов
POST   /api/v1/admin/inventory/acts/{id}/items - Добавление позиций
POST   /api/v1/admin/inventory/acts/{id}/complete - Завершение инвентаризации
POST   /api/v1/admin/inventory/auto-reconcile  - Автосверка остатков
GET    /api/v1/admin/inventory/discrepancies   - Расхождения

# Штрихкоды и RFID
POST   /api/v1/admin/assets/{id}/barcode      - Генерация штрихкода
GET    /api/v1/admin/barcodes/{code}          - Поиск по штрихкоду
POST   /api/v1/admin/assets/{id}/rfid         - Привязка RFID метки
GET    /api/v1/admin/rfid/{tag}              - Поиск по RFID
```

### Интерфейс админки

#### Навигация по типам активов
- Фильтры по типу, категории, статусу
- Поиск по названию, серийному номеру, артикулу
- Массовые операции (импорт, экспорт, обновление)

#### Карточка актива
- Основная информация
- Специфические атрибуты по типу
- История операций
- Связанные документы (приходы, списания, обслуживание)

#### Аналитика
- Распределение по типам и категориям
- Статусы активов
- Амортизация и остаточная стоимость
- График обслуживания

## Бизнес-процессы

### 1. Поступление активов
1. Создание приходного документа
2. Присвоение серийных номеров (для оборудования)
3. Определение начальной стоимости
4. Распределение по проектам/складам

### 2. Эксплуатация
1. Отслеживание использования
2. Планирование обслуживания
3. Фиксация ремонтов и ТО
4. Расчет амортизации

### 3. Инвентаризация
1. Плановая инвентаризация
2. Сверка фактического наличия
3. Исправление расхождений
4. Переоценка стоимости

### 4. Выбытие
1. Оформление акта списания
2. Расчет остаточной стоимости
3. Удаление из эксплуатации
4. Архивация данных

### 5. Складские операции
1. Управление складской сетью
2. Перемещение активов между складами
3. Резервирование для проектов
4. Отслеживание местоположения

### 6. Инвентаризация
1. Создание акта инвентаризации
2. Фиксация фактических остатков
3. Автоматическая сверка с учетными данными
4. Исправление расхождений
5. Формирование отчетов

## Интеграции

### Существующие модули
- **Материалы**: совместимость с текущей системой
- **Проекты**: привязка активов к проектам
- **Отчетность**: расширенные отчеты по активам
- **AI Assistant**: умные запросы по активам

### Внешние системы
- **Бухгалтерские системы**: передача данных об активах
- **Складские системы**: синхронизация остатков
- **Системы ТОиР**: графики обслуживания

## Этапы реализации

### Фаза 1: Базовая инфраструктура
1. Создание enum'ов для типов и категорий
2. Расширение модели Material до Asset
3. Миграции для новых полей
4. Базовые API endpoints

### Фаза 2: Специализированные типы
1. Модели для Equipment, Tool, Furniture
2. Система динамических атрибутов
3. Специфические бизнес-правила

### Фаза 3: Продвинутые возможности
1. Жизненный цикл активов
2. Амортизационный учет
3. Система обслуживания и ремонтов

### Фаза 4: Интеграция и аналитика
1. Расширенные отчеты
2. Интеграция с AI Assistant
3. Мобильные интерфейсы

## Риски и mitigation

### Технические риски
- **Производительность**: оптимизация запросов, кеширование
- **Сложность модели**: постепенная миграция, обратная совместимость
- **Интеграция**: модульный подход, API-first дизайн

### Бизнес-риски
- **Изменение процессов**: обучение пользователей, поэтапный переход
- **Перенос данных**: автоматизированные скрипты миграции
- **Совместимость**: поддержка старого формата данных

## Метрики успеха

### Функциональные
- Полное покрытие типов активов на стройплощадке
- Автоматизация основных операций учета
- Интеграция со всеми существующими модулями

### Технические
- Производительность запросов (< 500мс)
- Надежность (99.9% uptime)
- Масштабируемость (поддержка 100k+ активов)

### Бизнес
- Снижение времени на учет операций на 60%
- Повышение точности инвентаризации
- Улучшение контроля за активами
