# Спецификация: Унифицированная система уведомлений

## Цель

Создать мощную, масштабируемую и гибкую систему уведомлений для SaaS платформы, поддерживающую множественные каналы доставки (Email, Telegram, Push на сайте), кастомизацию через шаблоны и аналитику эффективности коммуникаций.

## Пользовательские истории

### Для конечных пользователей

- **Как пользователь**, я хочу получать уведомления о важных событиях (изменения в контрактах, алерты по бюджету, приглашения), **чтобы** быть в курсе изменений в моих проектах
- **Как пользователь**, я хочу самостоятельно настраивать, по каким каналам получать уведомления (email/telegram/push), **чтобы** контролировать способ коммуникации
- **Как пользователь**, я хочу видеть историю всех уведомлений и их статус, **чтобы** ничего не пропустить
- **Как пользователь**, я хочу получать real-time уведомления на сайте без обновления страницы, **чтобы** оперативно реагировать на события

### Для администраторов организации

- **Как администратор**, я хочу настраивать шаблоны уведомлений для моей организации, **чтобы** брендировать коммуникации (white-label)
- **Как администратор**, я хочу видеть аналитику по доставке и открытию уведомлений, **чтобы** оценивать эффективность
- **Как администратор**, я хочу определять, какие типы уведомлений обязательны, а какие опциональны, **чтобы** обеспечить критичные коммуникации
- **Как администратор**, я хочу создавать кастомные уведомления для специфичных бизнес-процессов, **чтобы** автоматизировать коммуникации

### Для разработчиков

- **Как разработчик**, я хочу простой API для отправки уведомлений из любой части системы, **чтобы** быстро интегрировать новые события
- **Как разработчик**, я хочу добавлять новые каналы доставки без изменения существующего кода, **чтобы** легко расширять систему

## Требования

### Функциональные требования

#### FR-1: Многоканальная доставка

- **FR-1.1**: Поддержка Email канала (SMTP/Resend)
- **FR-1.2**: Поддержка Telegram канала (Bot API)
- **FR-1.3**: Поддержка In-App уведомлений через WebSocket (Laravel Reverb)
- **FR-1.4**: Опциональная поддержка Browser Push Notifications (Web Push API)
- **FR-1.5**: Возможность добавления новых каналов через Driver Pattern

#### FR-2: Типы уведомлений

- **FR-2.1**: **Транзакционные** - подтверждения действий, инвойсы, статусы платежей (обязательные)
- **FR-2.2**: **Системные** - алерты по дашбордам, превышение лимитов, дедлайны (настраиваемые)
- **FR-2.3**: **Коммуникационные** - приглашения, комментарии, уведомления (настраиваемые)
- **FR-2.4**: **Маркетинговые** - анонсы функций, рассылки (опциональные)
- **FR-2.5**: **Кастомные** - определяемые администратором организации (настраиваемые)

#### FR-3: Гибкая система настроек

- **FR-3.1**: Глобальные настройки по типам уведомлений (обязательные/опциональные)
- **FR-3.2**: Настройки на уровне организации (дефолтные каналы)
- **FR-3.3**: Персональные настройки пользователя (переопределение каналов для опциональных типов)
- **FR-3.4**: Quiet hours (период тишины) - отключение неважных уведомлений в определенное время
- **FR-3.5**: Частотное ограничение (rate limiting) - группировка похожих уведомлений

#### FR-4: Система шаблонов

- **FR-4.1**: Blade-шаблоны для Email с поддержкой переменных
- **FR-4.2**: Markdown-шаблоны для Telegram с форматированием
- **FR-4.3**: JSON-шаблоны для In-App/Push уведомлений
- **FR-4.4**: Поддержка мультиязычности (локализация шаблонов)
- **FR-4.5**: Кастомизация шаблонов на уровне организации (white-label)
- **FR-4.6**: Предпросмотр шаблонов перед сохранением
- **FR-4.7**: Версионирование шаблонов (история изменений)

#### FR-5: Очереди и приоритизация

- **FR-5.1**: Асинхронная отправка через Redis Queue
- **FR-5.2**: Приоритетные очереди (critical > high > normal > low)
- **FR-5.3**: Отложенная отправка (scheduled delivery)
- **FR-5.4**: Retry механизм при сбоях (3 попытки с экспоненциальной задержкой)
- **FR-5.5**: Dead Letter Queue для неуспешных отправок

#### FR-6: Аналитика и отслеживание

- **FR-6.1**: Отслеживание статусов доставки (pending, sent, delivered, failed, read)
- **FR-6.2**: Email tracking - открытия (opens) и клики (clicks)
- **FR-6.3**: Статистика по каналам (delivery rate, open rate, click rate)
- **FR-6.4**: Статистика по типам уведомлений
- **FR-6.5**: Dashboard с метриками эффективности
- **FR-6.6**: Экспорт аналитики в CSV/Excel

#### FR-7: История и управление

- **FR-7.1**: Централизованная история всех уведомлений пользователя
- **FR-7.2**: Фильтрация по каналу, типу, статусу, дате
- **FR-7.3**: Поиск по содержимому уведомлений
- **FR-7.4**: Пометка как прочитанное/непрочитанное
- **FR-7.5**: Удаление/архивация уведомлений
- **FR-7.6**: Массовые операции (mark all as read, delete read)

#### FR-8: API для разработчиков

- **FR-8.1**: Простой фасад для отправки: `Notify::send($user, $notification)`
- **FR-8.2**: Event-driven подход (события автоматически генерируют уведомления)
- **FR-8.3**: Возможность переопределения каналов в runtime
- **FR-8.4**: Хуки для модификации данных перед отправкой
- **FR-8.5**: Тестовый режим (dry run) для отладки

### Нефункциональные требования

#### NFR-1: Производительность

- Отправка в очередь < 50ms
- Обработка уведомления из очереди < 2s для простых, < 10s для сложных
- Поддержка до 10,000 уведомлений в минуту
- WebSocket latency < 100ms для In-App уведомлений

#### NFR-2: Надежность

- Гарантия доставки 99.9% для критичных уведомлений
- Автоматический retry при сбоях
- Логирование всех попыток отправки
- Мониторинг очередей и алертинг при проблемах

#### NFR-3: Безопасность

- Шифрование персональных данных в уведомлениях
- Ограничение доступа к настройкам уведомлений (только владелец)
- Rate limiting для предотвращения спама
- Валидация и санитизация контента шаблонов

#### NFR-4: Масштабируемость

- Горизонтальное масштабирование workers для очередей
- Поддержка нескольких WebSocket серверов (broadcast)
- Архивация старых уведомлений (> 90 дней) в отдельное хранилище
- Кэширование настроек пользователей

#### NFR-5: Расширяемость

- Driver Pattern для легкого добавления новых каналов (SMS, Slack, Discord)
- Plugin система для кастомных типов уведомлений
- Webhooks для интеграции с внешними системами
- Open API для сторонних приложений

## Критерии приемки

### AC-1: Базовая функциональность

- [ ] Система успешно отправляет Email уведомления через Resend
- [ ] Система успешно отправляет Telegram уведомления через Bot API
- [ ] Система успешно отправляет In-App уведомления через WebSocket
- [ ] Все уведомления логируются в базу данных
- [ ] История уведомлений доступна через UI

### AC-2: Настройки

- [ ] Пользователь может выбрать каналы для каждого типа уведомлений
- [ ] Обязательные уведомления отправляются независимо от настроек
- [ ] Администратор может определять дефолтные настройки для организации
- [ ] Quiet hours корректно блокируют неважные уведомления

### AC-3: Шаблоны

- [ ] Администратор может создавать/редактировать шаблоны
- [ ] Шаблоны поддерживают переменные ({{user.name}}, {{project.name}})
- [ ] Шаблоны корректно рендерятся для всех каналов
- [ ] Превью шаблонов работает корректно

### AC-4: Аналитика

- [ ] Dashboard показывает статистику доставки по каналам
- [ ] Отслеживаются открытия Email уведомлений
- [ ] Можно экспортировать отчеты в CSV
- [ ] Статистика обновляется в реальном времени

### AC-5: Производительность

- [ ] 1000 уведомлений обрабатываются менее чем за 10 минут
- [ ] In-App уведомления доставляются < 500ms после события
- [ ] Нагрузочное тестирование: система справляется с 5000 уведомлений/мин

### AC-6: Интеграция

- [ ] Все существующие события (Contract, Dashboard Alerts, Invitations) интегрированы
- [ ] API для отправки уведомлений документирован в OpenAPI
- [ ] Написаны миграции и seeders для тестовых данных

## Технические ограничения

- **Laravel 11.x** - используем встроенные Notifications + Events
- **Redis** - для очередей и WebSocket broadcasting
- **Laravel Reverb** - для WebSocket сервера (Laravel 11 native)
- **Resend** - для Email (уже настроен)
- **Telegram Bot API** - существующий TelegramService
- **PostgreSQL** - для хранения истории и настроек

## Зависимости

### Внутренние

- **Authorization System** - проверка прав на управление шаблонами
- **Organization Context** - мультитенантность для настроек
- **User Model** - связь с получателями уведомлений
- **Logging System** - логирование всех операций

### Внешние

- **Laravel Reverb** (новая зависимость) - WebSocket сервер
- **Resend SDK** (уже установлен) - Email доставка
- **Telegram Bot API** (уже настроен) - Telegram доставка
- **Laravel Horizon** (опционально) - мониторинг очередей

## Архитектурные решения

### Структура модуля

```
app/BusinessModules/Features/Notifications/
├── Models/
│   ├── Notification.php              # Основная модель уведомления
│   ├── NotificationTemplate.php      # Шаблоны
│   ├── NotificationPreference.php    # Настройки пользователя
│   └── NotificationAnalytics.php     # Аналитика
├── Services/
│   ├── NotificationService.php       # Главный сервис
│   ├── TemplateRenderer.php          # Рендеринг шаблонов
│   └── AnalyticsService.php          # Сбор аналитики
├── Channels/
│   ├── EmailChannel.php              # Email драйвер
│   ├── TelegramChannel.php           # Telegram драйвер
│   ├── InAppChannel.php              # In-App драйвер
│   └── PushChannel.php               # Browser Push (опц.)
├── Notifications/                     # Конкретные типы
│   ├── TransactionalNotification.php
│   ├── SystemAlertNotification.php
│   ├── InvitationNotification.php
│   └── CustomNotification.php
├── Events/
│   ├── NotificationSent.php
│   ├── NotificationDelivered.php
│   └── NotificationRead.php
├── Jobs/
│   ├── SendNotificationJob.php
│   └── ProcessAnalyticsJob.php
└── Http/
    ├── Controllers/
    │   ├── NotificationController.php
    │   ├── NotificationPreferencesController.php
    │   ├── NotificationTemplatesController.php
    │   └── NotificationAnalyticsController.php
    └── Requests/
        └── ...
```

### База данных

**Таблица: notifications** (расширение стандартной Laravel)
- id, type, notifiable_type, notifiable_id
- data (JSON) - контент уведомления
- read_at, created_at, updated_at
- **Дополнительно:**
  - organization_id
  - notification_type (enum: transactional, system, communication, marketing, custom)
  - priority (enum: critical, high, normal, low)
  - channels (JSON) - список каналов доставки
  - delivery_status (JSON) - статус по каждому каналу
  - metadata (JSON) - дополнительные данные

**Таблица: notification_templates**
- id, organization_id, type, channel
- name, subject, content
- variables (JSON) - список переменных
- is_default, is_active
- version, parent_template_id
- created_by, updated_by
- timestamps, soft_deletes

**Таблица: notification_preferences**
- id, user_id, organization_id
- notification_type
- enabled_channels (JSON) - [email, telegram, in_app]
- quiet_hours_start, quiet_hours_end
- frequency_limit (JSON) - ограничения по типам
- metadata (JSON)
- timestamps

**Таблица: notification_analytics**
- id, notification_id
- channel, status
- sent_at, delivered_at, opened_at, clicked_at
- error_message, retry_count
- metadata (JSON)
- timestamps

**Таблица: notification_webhooks** (для интеграций)
- id, organization_id
- url, secret, events (JSON)
- is_active
- timestamps

## Приоритеты реализации

### Phase 1: Ядро (MVP)
1. Базовая модель и миграции
2. Email канал (Resend интеграция)
3. In-App канал (database)
4. Простые настройки пользователя
5. История уведомлений

### Phase 2: Расширение каналов
1. Telegram канал (рефакторинг существующего)
2. WebSocket In-App (Laravel Reverb)
3. Система приоритетов и очередей
4. Retry механизм

### Phase 3: Шаблоны и кастомизация
1. Система шаблонов
2. Переменные и рендеринг
3. Мультиязычность
4. White-label для организаций

### Phase 4: Аналитика и оптимизация
1. Tracking opens/clicks
2. Dashboard с метриками
3. Экспорт отчетов
4. Оптимизация производительности

### Phase 5: Расширенные функции
1. Browser Push Notifications
2. Webhooks для интеграций
3. Кастомные типы уведомлений
4. API для внешних систем

## Метрики успеха

- **Доставка**: > 99% успешных отправок для критичных уведомлений
- **Скорость**: < 2 секунды от события до отправки в очередь
- **Engagement**: > 40% открываемость Email уведомлений
- **Удовлетворенность**: < 5% пользователей отключают уведомления полностью
- **Масштабируемость**: система справляется с 10x ростом нагрузки

