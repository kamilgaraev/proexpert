# AI Assistant - Полная интеграция проектов и контрактов

## Обзор изменений

Полностью переработан AI Assistant для работы с проектами, контрактами и материалами. Все Actions теперь используют прямые SQL запросы вместо зависимости от виджетов.

## Исправленные ошибки

### 1. Материалы ✅
**CheckMaterialStockAction**
- **Было**: Использовал виджеты и обращался к несуществующей колонке `total_quantity`
- **Стало**: Прямые SQL запросы с правильными колонками `available_quantity` и `reserved_quantity` из таблицы `material_balances`
- **Функционал**: Получение остатков материалов, низких запасов, общей стоимости инвентаря

### 2. Команда и пользователи ✅
**GetTeamInfoAction** и **GetUserInfoAction**
- **Было**: Обращались к несуществующей связи `roles` на модели User
- **Стало**: Используют методы `getRoles($context)` из новой системы авторизации с `AuthorizationContext`
- **Функционал**: Получение информации о пользователях и их ролях в контексте организации

### 3. Бюджет проектов ✅
**GetProjectBudgetAction**
- **Было**: Зависимость от виджета
- **Стало**: Прямой SQL запрос с подсчетом бюджета и затрат из `completed_works`
- **Функционал**: Анализ бюджета всех проектов с процентом использования

### 4. Статус проектов ✅
**GetProjectStatusAction**
- **Было**: Зависимость от виджета
- **Стало**: Прямой SQL запрос для получения статусов проектов
- **Функционал**: Статистика по проектам (активные, завершенные, приостановленные, отмененные, архивные)

### 5. Риски проектов ✅
**AnalyzeProjectRisksAction**
- **Было**: Зависимость от трех виджетов
- **Стало**: Прямой SQL запрос с анализом рисков по срокам и бюджету
- **Функционал**: Выявление проектов с рисками превышения бюджета (> 80%) и срыва сроков (< 30 дней до дедлайна)

### 6. Прогноз материалов ✅
**ForecastMaterialNeedsAction**
- **Было**: Зависимость от двух виджетов
- **Стало**: Прямой SQL запрос с прогнозированием на основе исторических данных
- **Функционал**: Прогноз потребностей в материалах на 30 дней на основе последних 90 дней использования

### 7. Поиск контрактов ✅
**SearchContractsAction**
- **Было**: Использовал Eloquent с минимумом данных
- **Стало**: Прямые SQL запросы с полной информацией о контрактах, подрядчиках и проектах
- **Функционал**: Расширенный поиск контрактов с фильтрацией по статусу, типу, подрядчику, проекту

## Новые Actions

### 1. GetProjectDetailsAction ✨
**Назначение**: Получение детальной информации об одном проекте

**Возвращаемые данные**:
- Основная информация о проекте (название, адрес, описание, заказчик, проектировщик)
- Сроки выполнения и количество оставшихся дней
- Бюджет и затраты с процентом использования
- Статистика по материалам (общее количество, зарезервировано, типов материалов)
- Команда проекта (участники и их роли)
- Связанные контракты с суммами

**Пример запроса**: "Расскажи про проект Детский сад №453"

### 2. SearchProjectsAction ✨
**Назначение**: Поиск и фильтрация проектов

**Параметры фильтрации**:
- Статус (active, completed, paused, cancelled)
- Архивные/активные
- По заказчику
- По названию
- По адресу

**Возвращаемые данные**:
- Список проектов с полной информацией
- Бюджет и затраты каждого проекта
- Группировка по статусам
- Общие суммы бюджетов и затрат

**Пример запроса**: "Найди все активные проекты"

## Новые интенты

### 1. project_details (приоритет: 10)
**Паттерны**:
- "проект №"
- "детали проект"
- "подробности проект"
- "информация о проект"
- "расскажи про проект"
- "что по проекту"
- "о проекте"

**Action**: GetProjectDetailsAction

### 2. project_search (приоритет: 6)
**Паттерны**:
- "найди проект"
- "поиск проект"
- "проект по адрес"
- "проект с названи"
- "где проект"

**Action**: SearchProjectsAction

## Архитектура

### Принципы
1. **Независимость**: AI Assistant не зависит от модуля Advanced Dashboard
2. **Прямые запросы**: Все Actions используют SQL запросы напрямую к базе данных
3. **Правильность**: Все запросы используют реальные колонки из миграций
4. **Производительность**: Оптимизированные SQL запросы с JOIN и GROUP BY
5. **Совместимость**: Правильное использование новой системы авторизации

### Структура таблиц

#### Projects
- `id`, `name`, `address`, `description`
- `customer`, `designer`, `budget_amount`
- `start_date`, `end_date`, `status`
- `is_archived`, `is_head`

#### Contracts
- `id`, `number`, `date`, `type`, `subject`
- `status`, `total_amount`
- `contractor_id`, `project_id`
- `start_date`, `end_date`
- `gp_percentage`, `planned_advance_amount`

#### Materials
- `id`, `name`, `code`, `category`
- `measurement_unit_id`, `default_price`
- `organization_id`

#### Material Balances
- `id`, `material_id`, `project_id`
- `available_quantity`, `reserved_quantity`
- `average_price`

#### Material Write-offs
- `id`, `material_id`, `project_id`
- `quantity`, `write_off_date`
- `work_type_id`, `user_id`

#### Completed Works
- `id`, `project_id`, `work_type_id`
- `quantity`, `price`, `total_amount`
- `completion_date`, `status`

## Маппинг интентов на Actions

```php
$actionMap = [
    // Проекты
    'project_details' => GetProjectDetailsAction::class,
    'project_search' => SearchProjectsAction::class,
    'project_status' => GetProjectStatusAction::class,
    'project_budget' => GetProjectBudgetAction::class,
    'project_risks' => AnalyzeProjectRisksAction::class,
    
    // Контракты
    'contract_search' => SearchContractsAction::class,
    'contract_details' => GetContractDetailsAction::class,
    
    // Материалы
    'material_stock' => CheckMaterialStockAction::class,
    'material_forecast' => ForecastMaterialNeedsAction::class,
    
    // Системная информация
    'user_info' => GetUserInfoAction::class,
    'team_info' => GetTeamInfoAction::class,
    'organization_info' => GetOrganizationInfoAction::class,
    'help' => GetHelpAction::class,
];
```

## Примеры использования

### Материалы
```
Пользователь: "Остаток материалов"
AI: Показывает все материалы с количеством, зарезервировано, цены, общую стоимость

Пользователь: "Какие материалы заканчиваются?"
AI: Список материалов с низкими остатками (< 10 единиц)
```

### Проекты
```
Пользователь: "Давай по всем проектам"
AI: Статистика всех проектов по статусам

Пользователь: "Расскажи про проект Детский сад №453"
AI: Полная информация о проекте: сроки, бюджет, команда, контракты, материалы

Пользователь: "Найди активные проекты"
AI: Список всех активных проектов с бюджетами и затратами

Пользователь: "Какие проекты в зоне риска?"
AI: Проекты с рисками по срокам и бюджету
```

### Контракты
```
Пользователь: "Покажи все контракты"
AI: Список контрактов с подрядчиками, проектами, суммами

Пользователь: "Контракты по проекту Детский сад"
AI: Все контракты связанные с этим проектом
```

### Команда
```
Пользователь: "Кто работает в компании?"
AI: Список сотрудников с их ролями в организации

Пользователь: "Кто я?"
AI: Информация о текущем пользователе, его роли и права
```

## Преимущества новой архитектуры

1. **Быстродействие**: Прямые SQL запросы быстрее, чем через виджеты
2. **Надежность**: Нет зависимости от других модулей
3. **Гибкость**: Легко добавлять новые фильтры и параметры
4. **Понятность**: Легко читать и поддерживать SQL запросы
5. **Масштабируемость**: Простое добавление новых Actions и интентов

## Что дальше?

Возможные улучшения:
1. Добавить Actions для работы с выполненными работами
2. Добавить аналитику по подрядчикам
3. Добавить отчеты по затратам материалов
4. Добавить прогнозирование завершения проектов
5. Интеграция с календарем и уведомлениями

