# Интеграция коэффициентов расхода и стоимости

Данный документ описывает, как фронтенд должен обращаться к API для расчёта коэффициентов и как выводить полученные данные. **Все перечисления и поля приведены полностью, дополнительных «справочников» не требуется.**

---

## 1. Онлайн-расчёт коэффициентов

### Эндпойнт
```
POST /api/v1/admin/rate-coefficients/apply
```

### Тело запроса
| Поле | Тип | Обяз. | Допустимые значения | Описание |
|------|-----|-------|---------------------|----------|
| `original_value` | number (float) | ✔ | ≥ 0 | Исходное значение (норма, сумма, человеко-часы) |
| `applies_to` | string | ✔ | `material_norms` · `work_costs` · `labor_hours` · `general` | На какие показатели действует коэффициент |
| `scope` | string | ✖ | `global_org` · `project` · `work_type_category` · `work_type` · `material_category` · `material` | Область действия коэффициента |
| `contextual_ids` | object | ✖ | См. ниже | Идентификаторы сущностей, на которые ссылается коэффициент |
| `date` | string (YYYY-MM-DD) | ✖ | — | Дата, для которой делается расчёт (если нужен ретро-расчёт) |

#### Возможные ключи `contextual_ids`
| Ключ | Используется, если `scope` = |
|------|---------------------------|
| `project_id` | `project` |
| `work_type_category_id` | `work_type_category` |
| `work_type_id` | `work_type` |
| `material_category_id` | `material_category` |
| `material_id` | `material` |

> **Пример:** для коэффициента «Наценка 5 % на материалы проекта» (`applies_to = material_norms`, `scope = project`) в `contextual_ids` должен быть только `project_id`.

### Пример запроса
```json
{
  "original_value": 120,
  "applies_to": "material_norms",
  "scope": "project",
  "contextual_ids": {"project_id": 15, "material_id": 67},
  "date": "2025-07-17"
}
```

### Пример ответа
```json
{
  "original": 120.0,
  "final": 138.6,
  "applications": [
    {
      "id": 7,
      "name": "Зимний период",
      "type": "percentage",          // percentage | fixed_addition
      "value": 15,
      "before": 120.0,
      "after": 138.0
    },
    {
      "id": 9,
      "name": "Транспортировка",
      "type": "fixed_addition",
      "value": 0.6,
      "before": 138.0,
      "after": 138.6
    }
  ]
}
```

### UI-поведение (must-have)
1. При изменении проекта / материала / вида работ / количества отправлять запрос.
2. Поле «Итого с коэффициентами» показывать значение `final`.
3. Иконка «ℹ» или кнопка «Коэффициенты» выводит popover/модал с таблицей `applications` (колонки: *название*, *тип* (`+N` или `+N %`), *до*, *после*).
4. Если массив `applications` пуст — иконку не показывать.

---

## 2. Отчёт «Выполненные работы» (`GET /api/v1/admin/reports/work-completion`)

Каждый элемент массива `data` расширен полями:
| Поле | Тип | Описание |
|------|-----|----------|
| `total_price_adjusted` | float | Сумма с учётом коэффициентов |
| `coefficients_applied` | array | Список применённых коэффициентов — в том же формате, что `applications` выше |

### UI (таблица)
| Заголовок | Поле API | Комментарий |
|-----------|----------|-------------|
| Сумма, без коэффициентов | `total_price` | Можно скрыть по умолчанию |
| Сумма, с коэффициентами | `total_price_adjusted` | Основное отображаемое значение |
| Коэффициенты | `coefficients_applied` | Иконка ℹ + popover |

### Экспорт CSV / Excel
Добавить две колонки:
1. **Total Price Adjusted** — число.
2. **Coefficients** — JSON строки вида `["Зимний период +15%","Трансп. +0.6"]`.

---

## 3. Отчёт «Расход материалов» (`GET /api/v1/admin/reports/material-usage`)

*Новые поля уже добавлены ранее.*  Используйте их аналогично.

| Колонка | Поле API |
|---------|----------|
| Норма, исходная | `usage.production_norm` из первой записи `applications.before` |
| Норма, с коэффициентами | `usage.production_norm` |
| Коэффициенты | `coefficients_applied` |

---

## 4. Универсальный компонент Vue/React
```jsx
<CoefficientsInfo
  value={final}                     // итоговое значение
  applications={applications}       // массив с деталями
/>
```
* При наведении/клике выводит таблицу:
```
╔═════════════════╦════╦══════╦══════╗
║ Коэффициент     ║Тип ║До    ║После ║
╠═════════════════╬════╬══════╬══════╣
║ Зимний период   ║+15%║120   ║138   ║
║ Транспортировка ║+0.6║138   ║138.6 ║
╚═════════════════╩════╩══════╩══════╝
```

---

## 5. Проверка
1. Создать тестовый коэффициент (Напр. +10 % к `work_costs` scope=`project`).
2. В UI «Выполненные работы» сумма должна вырасти на 10 %, иконка ℹ показать 1 запись.
3. В форме создания/редактирования работ онлайн-калькулятор должен давать те же числа.

---

## 6. Обработка ошибок
| Код | Причина | Действие фронта |
|-----|---------|-----------------|
| 400 | Некорректный параметр / отсутствует контекст орг | Показать toast «Не удалось рассчитать коэффициенты» |
| 422 | `original_value` < 0 | Заблокировать сохранение формы |

---

Документ самодостаточен и перечисляет **все** допустимые значения и поля. 