# Инструкция по интеграции функциональности материалов к выполненным работам

## Обзор изменений

В API добавлена возможность привязки материалов к выполненным работам. Теперь при создании или редактировании выполненной работы можно указать какие материалы и в каком количестве были фактически использованы. Это позволяет вести детальный учет расхода материалов по каждой работе.

## Основные изменения в API

### Изменения в существующих эндпоинтах

Все эндпоинты для работы с выполненными работами теперь возвращают дополнительное поле `materials` в ответе:

- `GET /api/v1/admin/completed-works` - список работ теперь включает материалы
- `GET /api/v1/admin/completed-works/{id}` - детальная информация включает материалы
- `POST /api/v1/admin/completed-works` - можно передать массив `materials` при создании
- `PUT /api/v1/admin/completed-works/{id}` - можно передать массив `materials` при обновлении

### Новые эндпоинты

- `POST /api/v1/admin/completed-works/{id}/sync-materials` - синхронизация материалов для существующей работы
- `GET /api/v1/admin/completed-works/work-type-material-defaults?work_type_id={id}` - получение норм материалов по виду работ

## Структуры данных

### Объект материала в выполненной работе

При получении данных каждый материал содержит:

- `material_id` - ID материала
- `material_name` - название материала
- `measurement_unit` - единица измерения
- `quantity` - фактическое количество использованного материала
- `unit_price` - цена за единицу на момент списания (может быть null)
- `total_amount` - общая стоимость (может быть null)
- `notes` - примечания к использованию материала (может быть null)
- `created_at` - дата создания записи
- `updated_at` - дата обновления записи

### Объект для отправки материала

При отправке данных для каждого материала нужно указать:

- `material_id` - обязательный, ID материала
- `quantity` - обязательный, количество (минимум 0.0001)
- `unit_price` - необязательный, цена за единицу
- `total_amount` - необязательный, общая стоимость
- `notes` - необязательный, примечания (максимум 1000 символов)

## Примеры использования

### Создание работы с материалами

При создании новой выполненной работы можно сразу указать использованные материалы:

```json
{
  "project_id": 1,
  "work_type_id": 3,
  "user_id": 4,
  "quantity": 10.5,
  "completion_date": "2025-01-21",
  "status": "confirmed",
  "materials": [
    {
      "material_id": 5,
      "quantity": 2.5,
      "unit_price": 100.00,
      "total_amount": 250.00,
      "notes": "Основной материал"
    }
  ]
}
```

### Обновление материалов существующей работы

Для полной замены списка материалов используйте эндпоинт синхронизации:

```json
POST /api/v1/admin/completed-works/123/sync-materials
{
  "materials": [
    {
      "material_id": 5,
      "quantity": 3.0,
      "unit_price": 110.00,
      "total_amount": 330.00
    }
  ]
}
```

### Получение норм материалов

Для предзаполнения формы можно получить нормы расхода материалов по виду работ:

```
GET /api/v1/admin/completed-works/work-type-material-defaults?work_type_id=3
```

Ответ содержит массив материалов с нормативными количествами и ценами по умолчанию.

## Рекомендации по интеграции на фронтенде

### Форма создания/редактирования работы

1. Добавьте секцию "Материалы" в форму выполненной работы
2. Реализуйте возможность добавления/удаления материалов
3. При выборе вида работы подгружайте нормы материалов через эндпоинт `work-type-material-defaults`
4. Предзаполняйте поля количества и цены значениями из норм
5. Позволяйте пользователю корректировать предзаполненные значения
6. Добавьте валидацию на фронтенде: `material_id` обязателен, `quantity` больше 0

### Отображение списка работ

1. В таблице или карточках работ добавьте индикатор наличия материалов
2. Можно показать количество материалов или общую стоимость
3. При разворачивании детальной информации показывайте список материалов

### Детальная страница работы

1. Добавьте секцию с материалами
2. Показывайте таблицу: название материала, единица измерения, количество, цена, сумма
3. Добавьте кнопку редактирования материалов
4. Реализуйте модальное окно или отдельную страницу для редактирования

### Модальное окно редактирования материалов

1. Загружайте текущий список материалов при открытии
2. Позволяйте добавлять новые материалы через поиск или выпадающий список
3. Реализуйте возможность удаления материалов
4. При сохранении используйте эндпоинт `sync-materials`

## Пошаговый план интеграции

### Этап 1: Подготовка компонентов

1. Создайте компонент `MaterialSelector` для выбора материала
2. Создайте компонент `MaterialItem` для отображения одного материала в списке
3. Создайте компонент `MaterialsList` для отображения списка материалов
4. Обновите типы TypeScript для новых полей

### Этап 2: Обновление существующих форм

1. Добавьте поле `materials` в форму создания работы
2. Добавьте поле `materials` в форму редактирования работы
3. Обновите валидацию форм
4. Обновите методы отправки данных

### Этап 3: Обновление отображения

1. Обновите компонент списка работ для отображения информации о материалах
2. Обновите компонент детального просмотра работы
3. Добавьте индикаторы наличия материалов

### Этап 4: Реализация редактирования материалов

1. Создайте модальное окно или страницу редактирования материалов
2. Реализуйте API методы для синхронизации материалов
3. Добавьте обработку ошибок

### Этап 5: Интеграция с нормами

1. Добавьте API метод для получения норм материалов
2. Реализуйте автозаполнение при выборе вида работ
3. Добавьте возможность применения норм одним кликом

## Обработка ошибок

Предусмотрите обработку следующих ошибок:

- **400** - ошибки валидации (некорректные данные материалов)
- **403** - нет доступа к ресурсу
- **404** - работа или материал не найден
- **422** - бизнес-ошибки (например, недостаточно материалов на складе)

## Особенности работы с данными

1. Поле `materials` может быть `null` в ответах API
2. При создании работы поле `materials` необязательно
3. При обновлении если `materials` не передан, существующие материалы не изменяются
4. При обновлении если `materials` передан как пустой массив, все материалы будут удалены
5. Эндпоинт `sync-materials` полностью заменяет список материалов

## Тестирование

Протестируйте следующие сценарии:

1. Создание работы без материалов
2. Создание работы с материалами
3. Добавление материалов к существующей работе
4. Редактирование материалов работы
5. Удаление всех материалов работы
6. Получение норм материалов и их применение
7. Обработка ошибок валидации

## TypeScript типы

Рекомендуемые типы для фронтенда:

```typescript
interface CompletedWorkMaterial {
  material_id: number;
  material_name: string;
  measurement_unit: string;
  quantity: number;
  unit_price?: number;
  total_amount?: number;
  notes?: string;
  created_at: string;
  updated_at: string;
}

interface CompletedWorkMaterialInput {
  material_id: number;
  quantity: number;
  unit_price?: number;
  total_amount?: number;
  notes?: string;
}

interface CompletedWork {
  id: number;
  // ... другие поля
  materials?: CompletedWorkMaterial[];
}

interface WorkTypeMaterialDefault {
  material_id: number;
  material_name: string;
  default_price: number;
  quantity: number;
  notes?: string;
  measurement_unit: string;
}
``` 