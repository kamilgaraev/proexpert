# API для работы с материалами выполненных работ

## Обзор

API позволяет привязывать материалы к выполненным работам, что обеспечивает детальный учет фактического расхода материалов на каждую работу.

## Создание выполненной работы с материалами

### POST /api/v1/admin/completed-works

```json
{
  "project_id": 1,
  "contract_id": 2,
  "work_type_id": 3,
  "user_id": 4,
  "quantity": 10.5,
  "price": 1500.00,
  "total_amount": 15750.00,
  "completion_date": "2025-01-21",
  "notes": "Работа выполнена качественно",
  "status": "confirmed",
  "materials": [
    {
      "material_id": 5,
      "quantity": 2.5,
      "unit_price": 100.00,
      "total_amount": 250.00,
      "notes": "Основной материал"
    },
    {
      "material_id": 6,
      "quantity": 1.0,
      "unit_price": 50.00,
      "total_amount": 50.00
    }
  ]
}
```

### Ответ:

```json
{
  "success": true,
  "message": "Запись о выполненной работе успешно создана.",
  "data": {
    "id": 123,
    "organization_id": 1,
    "project": {...},
    "contract": {...},
    "work_type": {...},
    "user": {...},
    "quantity": 10.5,
    "price": 1500.00,
    "total_amount": 15750.00,
    "completion_date": "2025-01-21",
    "notes": "Работа выполнена качественно",
    "status": "confirmed",
    "materials": [
      {
        "material_id": 5,
        "material_name": "Кирпич красный",
        "measurement_unit": "шт",
        "quantity": 2.5,
        "unit_price": 100.00,
        "total_amount": 250.00,
        "notes": "Основной материал",
        "created_at": "2025-01-21 10:00:00",
        "updated_at": "2025-01-21 10:00:00"
      }
    ],
    "created_at": "2025-01-21 10:00:00",
    "updated_at": "2025-01-21 10:00:00"
  }
}
```

## Синхронизация материалов выполненной работы

### POST /api/v1/admin/completed-works/{id}/sync-materials

Полностью перезаписывает список материалов для выполненной работы.

```json
{
  "materials": [
    {
      "material_id": 5,
      "quantity": 3.0,
      "unit_price": 110.00,
      "total_amount": 330.00,
      "notes": "Обновленное количество"
    }
  ]
}
```

### Ответ:

```json
{
  "success": true,
  "message": "Материалы выполненной работы успешно синхронизированы.",
  "data": {
    // Полная информация о выполненной работе с обновленными материалами
  }
}
```

## Получение норм материалов по виду работ

### GET /api/v1/admin/completed-works/work-type-material-defaults?work_type_id=3

Возвращает нормы расхода материалов для указанного вида работ, которые можно использовать как значения по умолчанию.

### Ответ:

```json
{
  "success": true,
  "data": [
    {
      "material_id": 5,
      "material_name": "Кирпич красный",
      "default_price": 95.00,
      "quantity": 2.0,
      "notes": "Норма на 1 кв.м кладки",
      "measurement_unit": "шт"
    },
    {
      "material_id": 6,
      "material_name": "Цемент М400",
      "default_price": 450.00,
      "quantity": 0.5,
      "notes": "Для раствора",
      "measurement_unit": "мешок"
    }
  ]
}
```

## Обновление выполненной работы с материалами

### PUT /api/v1/admin/completed-works/{id}

```json
{
  "quantity": 12.0,
  "materials": [
    {
      "material_id": 5,
      "quantity": 3.5,
      "unit_price": 105.00,
      "total_amount": 367.50
    }
  ]
}
```

## Получение выполненной работы с материалами

### GET /api/v1/admin/completed-works/{id}

Возвращает полную информацию о выполненной работе, включая связанные материалы.

## Валидация

### Правила валидации для материалов:

- `materials` - необязательный массив
- `materials.*.material_id` - обязательный integer, должен существовать в таблице materials для данной организации
- `materials.*.quantity` - обязательный numeric, минимум 0.0001
- `materials.*.unit_price` - необязательный numeric, минимум 0
- `materials.*.total_amount` - необязательный numeric, минимум 0
- `materials.*.notes` - необязательная строка, максимум 1000 символов

## Коды ошибок

- `400` - Ошибка валидации данных
- `403` - Нет доступа к ресурсу
- `404` - Выполненная работа или материал не найден
- `422` - Ошибка бизнес-логики (например, недостаточно материалов на складе)

## Примечания

1. При создании/обновлении выполненной работы с материалами система автоматически создает записи списания материалов в таблице `MaterialWriteOff`.

2. Если `materials` не указан при создании, но есть нормы для данного вида работ в `work_type_materials`, можно использовать эндпоинт получения норм для предзаполнения.

3. Синхронизация материалов полностью заменяет существующий список. Для частичного обновления используйте PUT запрос на основной ресурс.

4. Все операции с материалами выполняются в рамках транзакции для обеспечения целостности данных. 