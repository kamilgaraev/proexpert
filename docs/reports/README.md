# Система шаблонов отчетов

## Что это?

Система позволяет пользователям **выбирать колонки** для экспорта отчетов. Вместо фиксированного набора колонок можно создавать свои шаблоны.

## Как это работает?

### 1. JSON файлы с системными шаблонами

```
config/report-templates/
  ├── contractor_summary.json    # 3 готовых шаблона
  └── contractor_detail.json     # 1 готовый шаблон
```

### 2. Автоматическая синхронизация

При **первом веб-запросе** после деплоя система автоматически:
- Проверяет наличие системных шаблонов в БД
- Если их нет - создает из JSON файлов
- Логирует результат

### 3. Ручная синхронизация (опционально)

```bash
# Создать шаблоны (если не существуют)
php artisan reports:sync-templates

# Обновить существующие шаблоны
php artisan reports:sync-templates --force

# Синхронизировать только один тип
php artisan reports:sync-templates --type=contractor_summary
```

## Использование

### API запрос с выбором шаблона

```http
GET /api/v1/admin/reports/contractor-summary
  ?project_id=7
  &export_format=xlsx
  &template_id=5    ← ID шаблона
```

### Без шаблона (дефолтное поведение)

```http
GET /api/v1/admin/reports/contractor-summary
  ?project_id=7
  &export_format=xlsx
```

Используется дефолтный набор колонок (без `contractor_type`)

## Обратная совместимость

✅ Фронтенд не сломается:
- Параметр `template_id` опциональный
- Если модуль `report-templates` выключен - параметр игнорируется
- Все существующие параметры работают как раньше

## Добавление новых шаблонов

1. Отредактируйте JSON в `config/report-templates/`
2. Запустите `php artisan reports:sync-templates --force`
3. Готово!

## Структура JSON шаблона

```json
{
  "name": "Название шаблона",
  "report_type": "contractor_summary",
  "is_default": false,
  "columns_config": [
    {
      "header": "Подрядчик",
      "data_key": "contractor_name",
      "order": 1,
      "format_options": null
    }
  ]
}
```

## Доступные колонки

См. конфиги в `config/reports/{report_type}.php`

## Документация

- **[contractor-report-templates.md](./contractor-report-templates.md)** - Полная документация по шаблонам
- **[SETUP.md](./SETUP.md)** - Инструкция по развертыванию и тестированию

## Архитектура

```
┌─────────────────┐
│  Веб-запрос     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  AppServiceProvider::boot() │ ◄── Проверка при старте
└────────┬────────────────────┘
         │
         ▼
┌──────────────────────────────┐
│ Есть системные шаблоны в БД? │
└────────┬─────────────────────┘
         │ НЕТ
         ▼
┌──────────────────────────────┐
│ Читаем JSON из config/       │
│ report-templates/            │
└────────┬─────────────────────┘
         │
         ▼
┌──────────────────────────────┐
│ Создаем записи ReportTemplate│
└──────────────────────────────┘
```

## Преимущества

✅ **Декларативность**: Шаблоны в JSON видны сразу  
✅ **Версионируемость**: JSON в git  
✅ **Идемпотентность**: Можно запускать многократно  
✅ **Автоматизация**: Не требует ручных действий  
✅ **Масштабируемость**: Легко добавлять новые типы отчетов  

## Что дальше?

- [ ] Создать API endpoint: `GET /api/v1/admin/report-columns/{reportType}`
- [ ] Применить к остальным отчетам (material_usage, work_completion, etc.)
- [ ] Добавить UI для создания пользовательских шаблонов
- [ ] Документировать в OpenAPI спецификации

