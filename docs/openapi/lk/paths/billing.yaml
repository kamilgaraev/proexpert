/billing/plans:
  get:
    tags: [Billing, Subscription]
    summary: Получить список доступных тарифных планов
    description: |
      Возвращает все доступные тарифные планы для оформления подписки организации.
      Требует права 'billing.manage'.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Список тарифных планов получен успешно
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/ApiResponse.yaml'
                - type: object
                  properties:
                    data:
                      type: array
                      items:
                        $ref: '../components/schemas/BillingPlan.yaml'

/billing/subscription:
  get:
    tags: [Billing, Subscription]
    summary: Получить текущую подписку организации
    description: |
      Возвращает информацию о текущей активной подписке организации.
      Если подписки нет, возвращает соответствующее сообщение.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Информация о подписке получена
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  properties:
                    has_subscription:
                      type: boolean
                      description: Есть ли активная подписка
                      example: true
                    subscription:
                      type: object
                      nullable: true
                      properties:
                        id:
                          type: integer
                          example: 5
                        status:
                          type: string
                          example: "active"
                        plan_name:
                          type: string
                          example: "Базовый"
                        plan_description:
                          type: string
                          example: "Базовый план для малого бизнеса"
                        is_trial:
                          type: boolean
                          example: false
                        trial_ends_at:
                          type: string
                          nullable: true
                          format: date-time
                          example: null
                        ends_at:
                          type: string
                          nullable: true
                          format: date-time
                          example: "2024-02-15 12:00:00"
                        next_billing_at:
                          type: string
                          nullable: true
                          format: date-time
                          example: "2024-02-01 12:00:00"
                        is_canceled:
                          type: boolean
                          example: false
                        is_auto_payment_enabled:
                          type: boolean
                          example: true
                    message:
                      type: string
                      nullable: true
                      example: null
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                error:
                  type: string
                  example: "Организация не найдена или нет доступа"
  patch:
    tags: [Billing, Subscription]
    summary: Обновить подписку организации
    description: |
      Обновляет подписку на новый план или изменяет настройки автоплатежа.
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              plan_slug:
                type: string
                description: Слаг нового плана
                example: "basic"
              is_auto_payment_enabled:
                type: boolean
                description: Включить автоплатеж
                example: true
    responses:
      "200":
        description: Подписка обновлена успешно
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  description: Обновленная подписка
                  additionalProperties: true

/billing/subscribe:
  post:
    tags: [Billing, Subscription]
    summary: Оформить подписку для организации
    description: |
      Оформляет новую подписку на выбранный план для организации.
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - plan_slug
            properties:
              plan_slug:
                type: string
                description: Слаг тарифного плана
                example: "basic"
              is_auto_payment_enabled:
                type: boolean
                description: Включить автоматические платежи
                default: true
                example: true
    responses:
      "200":
        description: Подписка оформлена успешно
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  description: Данные о созданной подписке
                  additionalProperties: true
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                error:
                  type: string
                  example: "Организация не найдена или нет доступа"

/billing/subscription/cancel:
  post:
    tags: [Billing, Subscription]
    summary: Отменить подписку организации
    description: |
      Отменяет текущую подписку организации. Доступ к функциям сохраняется до окончания периода.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Подписка отменена успешно
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  description: Отмененная подписка
                  additionalProperties: true
                message:
                  type: string
                  example: "Подписка отменена. Доступ сохранится до 15.02.2024"
      "400":
        description: Ошибка отмены подписки
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: false
                message:
                  type: string
                  example: "Невозможно отменить подписку"

/billing/subscription/change-plan-preview:
  post:
    tags: [Billing, Subscription]
    summary: Предварительный просмотр смены плана
    description: |
      Показывает что произойдет при смене тарифного плана (стоимость, пропорциональные расчеты и т.д.).
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - plan_slug
            properties:
              plan_slug:
                type: string
                description: Слаг нового плана для предпросмотра
                example: "premium"
    responses:
      "200":
        description: Предпросмотр смены плана получен
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  description: Детали предпросмотра
                  additionalProperties: true
                message:
                  type: string
                  example: "Доплата за смену плана составит 500 руб."
      "400":
        description: Ошибка получения предпросмотра
        content:
          application/json:
            schema:
              $ref: '../components/schemas/ApiResponse.yaml'
      "422":
        description: Ошибки валидации
        content:
          application/json:
            schema:
              $ref: '../components/schemas/ApiResponse.yaml'

/billing/subscription/change-plan:
  post:
    tags: [Billing, Subscription]
    summary: Сменить тарифный план
    description: |
      Выполняет смену тарифного плана подписки с пропорциональным перерасчетом стоимости.
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - plan_slug
            properties:
              plan_slug:
                type: string
                description: Слаг нового плана
                example: "premium"
    responses:
      "200":
        description: План успешно изменен
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  description: Обновленная подписка
                  additionalProperties: true
                billing_info:
                  type: object
                  nullable: true
                  description: Информация о биллинге
                  additionalProperties: true
                message:
                  type: string
                  example: "План успешно изменен на Premium"
      "400":
        description: Ошибка смены плана
        content:
          application/json:
            schema:
              $ref: '../components/schemas/ApiResponse.yaml'

/billing/subscription/auto-payment:
  patch:
    tags: [Billing, Subscription]
    summary: Включить/выключить автоплатеж подписки
    description: |
      Изменяет настройку автоматических платежей для текущей подписки организации.
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../components/schemas/AutoPaymentToggleRequest.yaml'
    responses:
      "200":
        description: Настройка автоплатежа обновлена
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/ApiResponse.yaml'
                - type: object
                  properties:
                    data:
                      $ref: '../components/schemas/UserSubscription.yaml'

/billing/subscription/limits:
  get:
    tags: [Billing, Subscription]
    summary: Получить лимиты текущей подписки
    description: |
      Возвращает лимиты и ограничения текущего тарифного плана организации.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Лимиты подписки получены успешно
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/ApiResponse.yaml'
                - type: object
                  properties:
                    data:
                      $ref: '../components/schemas/SubscriptionLimits.yaml'

/billing/balance:
  get:
    tags: [Billing, Balance]
    summary: Получить баланс организации
    description: |
      Возвращает текущий баланс организации и связанную информацию.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Баланс организации получен успешно
        content:
          application/json:
            schema:
              $ref: '../components/schemas/OrganizationBalance.yaml'
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Organization not found for this user."

/billing/balance/transactions:
  get:
    tags: [Billing, Balance]
    summary: Получить историю транзакций баланса
    description: |
      Возвращает список транзакций по балансу организации с пагинацией.
    security: 
      - bearerAuth: []
    parameters:
      - name: limit
        in: query
        description: Количество записей на страницу
        required: false
        schema:
          type: integer
          default: 15
          minimum: 1
          maximum: 100
    responses:
      "200":
        description: История транзакций получена успешно
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: array
                  items:
                    $ref: '../components/schemas/BalanceTransaction.yaml'
                links:
                  type: object
                  description: Ссылки пагинации
                meta:
                  type: object
                  description: Метаданные пагинации
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Organization not found."

/billing/balance/top-up:
  post:
    tags: [Billing, Balance]
    summary: Пополнить баланс организации
    description: |
      Инициирует процесс пополнения баланса организации через платежный шлюз.
    security: 
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - amount
              - currency
            properties:
              amount:
                type: number
                format: float
                minimum: 1
                description: Сумма пополнения в основной валюте (рублях)
                example: 1000.00
              currency:
                type: string
                minLength: 3
                maxLength: 3
                pattern: '^[A-Z]{3}$'
                description: Код валюты в формате ISO 4217
                example: "RUB"
              payment_method_token:
                type: string
                nullable: true
                description: Токен метода оплаты от платежного шлюза
                example: "tok_mock_visa"
    responses:
      "200":
        description: Запрос на пополнение создан успешно
        content:
          application/json:
            schema:
              $ref: '../components/schemas/PaymentGatewayChargeResponse.yaml'
      "400":
        description: Ошибка операции
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Неверная сумма или валюта"
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Organization not found for this user."
      "422":
        description: Ошибки валидации
        content:
          application/json:
            schema:
              $ref: '../components/schemas/ApiResponse.yaml'

/billing/dashboard:
  get:
    tags: [Billing, Dashboard]
    summary: Получить дашборд биллинга организации
    description: |
      Возвращает сводную информацию о биллинге организации: подписка, баланс, статистика платежей и т.д.
    security: 
      - bearerAuth: []
    responses:
      "200":
        description: Дашборд биллинга получен успешно
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  $ref: '../components/schemas/OrganizationDashboard.yaml'
      "404":
        description: Организация не найдена
        content:
          application/json:
            schema:
              type: object
              properties:
                error:
                  type: string
                  example: "Организация не найдена или нет доступа"