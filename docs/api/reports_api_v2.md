# API Документация: Формирование Отчетов и Управление Шаблонами

## Аутентификация

Все запросы к API отчетов и шаблонов требуют аутентификации администратора (JWT токен в заголовке `Authorization: Bearer <token>`).
- Для генерации отчетов: требуется право `view-reports` (проверяется через Gate `can:view-reports` в `ReportController`).
- Для управления шаблонами отчетов: (TODO: должен быть определен Gate, например, `manage-report-templates` и применен в `ReportTemplateController`).
Все маршруты также защищены общими middleware для админ-панели (`auth:api_admin`, `jwt.auth`, `organization.context`, `can:access-admin-panel`).

## Часть 1: Генерация Отчетов

### Общие параметры для генерации отчетов

-   `format` (string, опционально):
    -   Если не указан или значение отличное от `csv`, возвращается `JSON` ответ.
    -   Если `format=csv`, сервер вернет CSV файл для скачивания.
-   `template_id` (integer, опционально):
    -   ID шаблона отчета, который нужно использовать для формирования CSV файла.
    -   Если не указан, будет использован шаблон по умолчанию для данного типа отчета и организации (если он задан).
    -   Если шаблон по умолчанию не задан, будет использована стандартная структура колонок, определенная на бэкенде.
-   Параметры пагинации (`page`, `per_page`) и сортировки (`sort_by`, `sort_direction`) применяются **только для JSON ответа**. При запросе CSV (`format=csv`) выгружаются все отфильтрованные данные.

### 1.1. Отчет по расходу материалов

-   **URL:** `/api/v1/admin/reports/material-usage`
-   **Метод:** `GET`
-   **Описание:** Возвращает отчет по расходу (движению) материалов.
-   **Параметры запроса (Query Parameters) для фильтрации (применяются и для JSON, и для CSV):**
    -   `project_id` (integer, опционально): Фильтр по ID проекта.
    -   `material_id` (integer, опционально): Фильтр по ID материала.
    -   `user_id` (integer, опционально): Фильтр по ID пользователя (прораба).
    -   `date_from` (string, опционально, формат: `YYYY-MM-DD`): Начальная дата периода.
    -   `date_to` (string, опционально, формат: `YYYY-MM-DD`): Конечная дата периода.
    -   `operation_type` (string, опционально): Фильтр по типу операции (`receipt` - приемка, `write_off` - списание).
-   **Успешный ответ (JSON, если `format` не `csv`):**
    ```json
    {
        "title": "Отчет по расходу материалов",
        "filters": { /* примененные фильтры */ },
        "data": [ /* массив агрегированных данных или список логов в зависимости от реализации ReportService */ ],
        "pagination": { // Только если data - это пагинированный список логов
            "total": 70,
            "per_page": 15,
            "current_page": 1,
            "last_page": 5
        },
        "generated_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ"
    }
    ```
-   **Успешный ответ (CSV, если `format=csv`):**
    -   HTTP Status: `200 OK`
    -   Headers:
        -   `Content-Type: text/csv; charset=utf-8`
        -   `Content-Disposition: attachment; filename="material_usage_report_YYYYMMDDHHMMSS.csv"` (или имя на основе шаблона)
    -   Тело ответа: CSV данные, структура колонок зависит от примененного шаблона или маппинга по умолчанию.
        Пример колонок по умолчанию (порядок и наличие зависят от реализации и шаблона):
        `Дата операции;Проект;Материал;Ед. изм.;Тип операции;Количество;Цена за ед.;Сумма;Поставщик;Документ;Исполнитель;Примечание;Дата создания записи`
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`
    -   `422 Unprocessable Entity`: Ошибки валидации параметров запроса (из `MaterialUsageReportRequest`).
    -   `400 Bad Request`: Например, если не удалось определить колонки для CSV отчета из-за проблем с шаблоном.
    -   `500 Internal Server Error`.

### 1.2. Отчет по выполненным работам

-   **URL:** `/api/v1/admin/reports/work-completion`
-   **Метод:** `GET`
-   **Описание:** Возвращает отчет по выполненным работам.
-   **Параметры запроса (Query Parameters) для фильтрации:**
    -   `project_id` (integer, опционально): Фильтр по ID проекта.
    -   `work_type_id` (integer, опционально): Фильтр по ID вида работ.
    -   `user_id` (integer, опционально): Фильтр по ID пользователя (прораба).
    -   `date_from` (string, опционально, формат: `YYYY-MM-DD`): Начальная дата периода.
    -   `date_to` (string, опционально, формат: `YYYY-MM-DD`): Конечная дата периода.
-   **Успешный ответ (JSON, если `format` не `csv`):**
    ```json
    {
        "title": "Отчет по выполненным работам",
        "filters": { /* ... */ },
        "data": [ /* ... */ ],
        "pagination": { /* ... */ },
        "generated_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ"
    }
    ```
-   **Успешный ответ (CSV, если `format=csv`):**
    -   HTTP Status: `200 OK`
    -   Headers:
        -   `Content-Type: text/csv; charset=utf-8`
        -   `Content-Disposition: attachment; filename="work_completion_report_YYYYMMDDHHMMSS.csv"` (или имя на основе шаблона)
    -   Тело ответа: CSV данные.
        Пример колонок по умолчанию:
        `Дата выполнения;Проект;Вид работы;Ед. изм.;Объем;Цена за ед.;Сумма;Исполнитель;Примечание;Дата создания записи`
-   **Ошибки:** Аналогично отчету по материалам.

### 1.3. Отчет по активности прорабов

-   **URL:** `/api/v1/admin/reports/foreman-activity`
-   **Метод:** `GET`
-   **Описание:** Возвращает отчет по активности прорабов.
    *(Примечание: CSV экспорт для этого отчета пока не реализован с использованием шаблонов в `ReportService`. Если потребуется, необходима аналогичная доработка.)*
-   **Параметры запроса (Query Parameters) для фильтрации:**
    -   `project_id` (integer, опционально).
    -   `user_id` (integer, опционально).
    -   `date_from` (string, опционально, формат: `YYYY-MM-DD`).
    -   `date_to` (string, опционально, формат: `YYYY-MM-DD`).
-   **Успешный ответ (JSON):**
    ```json
    {
        "title": "Отчет по активности прорабов",
        "filters": { /* ... */ },
        "data": { /* данные об активности */ },
        "generated_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ"
    }
    ```
-   **Ошибки:** `401`, `403`, `422`, `500`.

### 1.4. Сводный отчет по статусам проектов

-   **URL:** `/api/v1/admin/reports/project-status-summary`
-   **Метод:** `GET`
-   **Описание:** Возвращает сводный отчет по статусам проектов.
    *(Примечание: CSV экспорт для этого отчета пока не реализован с использованием шаблонов в `ReportService`. Если потребуется, необходима аналогичная доработка.)*
-   **Параметры запроса (Query Parameters) для фильтрации:**
    -   `status` (string, опционально): Фильтр по статусу проекта.
    -   `is_archived` (boolean, опционально): Фильтр по архивным проектам.
-   **Успешный ответ (JSON):**
    ```json
    {
        "title": "Сводный отчет по статусам проектов",
        "filters": { /* ... */ },
        "data": { /* количество проектов по статусам */ },
        "generated_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ"
    }
    ```
-   **Ошибки:** `401`, `403`, `422`, `500`.

*(Примечание: Отчеты по подотчетным средствам из `AdvanceAccountReportController` уже имели свой механизм экспорта и здесь не детализируются повторно, но их можно будет интегрировать с системой шаблонов при необходимости).*

## Часть 2: Управление Шаблонами Отчетов

### Доступные типы отчетов для шаблонов (`report_type`)
-   `material_usage` (Отчет по расходу материалов)
-   `work_completion` (Отчет по выполненным работам)
-   `foreman_activity` (Отчет по активности прорабов)
-   `project_status_summary` (Сводный отчет по статусам проектов)

### Структура объекта `columns_config` (массив)
Каждый элемент массива - это объект со следующими полями:
-   `header` (string, required): Заголовок колонки в CSV файле.
-   `data_key` (string, required): Ключ для извлечения данных из модели лога/отчета. Может использовать "точечную нотацию" для вложенных отношений (например, `project.name`, `material.measurementUnit.symbol`).
-   `order` (integer, required, min:1): Порядковый номер колонки в отчете.
-   `format_options` (object, nullable): Дополнительные опции форматирования (пока не реализована их активная обработка, но зарезервировано).
    Пример: `{"date_format": "Y-m-d", "decimal_places": 2, "decimal_separator": "."}`

### 2.1. Список шаблонов отчетов

-   **URL:** `/api/v1/admin/report-templates`
-   **Метод:** `GET`
-   **Описание:** Возвращает пагинированный список шаблонов отчетов для текущей организации.
-   **Параметры запроса (Query Parameters):**
    -   `page` (integer, опционально, default: 1).
    -   `per_page` (integer, опционально, default: 15).
    -   `report_type` (string, опционально): Фильтр по типу отчета (см. доступные типы выше).
    -   `name` (string, опционально): Поиск по названию шаблона (частичное совпадение).
    -   `sort_by` (string, опционально, default: `name`). Доступные значения: `name`, `report_type`, `created_at`, `updated_at`.
    -   `sort_direction` (string, опционально, default: `asc`). Доступные значения: `asc`, `desc`.
-   **Успешный ответ (200 OK):**
    ```json
    {
        "data": [
            {
                "id": 1,
                "name": "Отчет по материалам (СБИС)",
                "report_type": "material_usage",
                "organization_id": 1,
                "user_id": 2, // ID пользователя, создавшего шаблон, или null
                "columns_config": [
                    { "header": "ID Материала", "data_key": "material_id", "order": 1, "format_options": null },
                    { "header": "Название", "data_key": "material.name", "order": 2, "format_options": null }
                    // ... другие колонки
                ],
                "is_default": true,
                "created_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ",
                "updated_at": "YYYY-MM-DDTHH:mm:ss.ssssssZ"
            }
            // ... другие шаблоны
        ],
        "links": { /* ... */ },
        "meta": { /* ... */ }
    }
    ```

### 2.2. Создание шаблона отчета

-   **URL:** `/api/v1/admin/report-templates`
-   **Метод:** `POST`
-   **Описание:** Создает новый шаблон отчета.
-   **Тело запроса (JSON):**
    ```json
    {
        "name": "Мой отчет по материалам для бухгалтерии",
        "report_type": "material_usage", // Обязательно, один из доступных типов
        "columns_config": [
            { "header": "Дата", "data_key": "usage_date", "order": 1 },
            { "header": "Проект (Название)", "data_key": "project.name", "order": 2 },
            { "header": "Материал (Название)", "data_key": "material.name", "order": 3 },
            { "header": "Кол-во", "data_key": "quantity", "order": 4 },
            { "header": "Ед.Изм.", "data_key": "material.measurementUnit.symbol", "order": 5 }
        ],
        "is_default": false // опционально, default: false
    }
    ```
-   **Успешный ответ (201 Created):** Тело ответа содержит созданный ресурс шаблона (см. структуру в п. 2.1).
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`.
    -   `422 Unprocessable Entity`: Ошибки валидации (неверный `report_type`, некорректный `columns_config` и т.д.).

### 2.3. Получение одного шаблона отчета

-   **URL:** `/api/v1/admin/report-templates/{template_id}`
-   **Метод:** `GET`
-   **Описание:** Возвращает детали одного шаблона отчета по его ID.
-   **Успешный ответ (200 OK):** Тело ответа содержит ресурс шаблона (см. структуру в п. 2.1).
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`.
    -   `404 Not Found`: Если шаблон с указанным ID не найден в текущей организации.

### 2.4. Обновление шаблона отчета

-   **URL:** `/api/v1/admin/report-templates/{template_id}`
-   **Метод:** `PUT` (или `PATCH`)
-   **Описание:** Обновляет существующий шаблон отчета.
-   **Тело запроса (JSON):** Аналогично созданию (п. 2.2), но все поля опциональны. Передаются только те поля, которые нужно изменить.
    ```json
    {
        "name": "Новое название отчета",
        "is_default": true
    }
    ```
-   **Успешный ответ (200 OK):** Тело ответа содержит обновленный ресурс шаблона.
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`.
    -   `404 Not Found`: Если шаблон не найден.
    -   `422 Unprocessable Entity`: Ошибки валидации.

### 2.5. Удаление шаблона отчета

-   **URL:** `/api/v1/admin/report-templates/{template_id}`
-   **Метод:** `DELETE`
-   **Описание:** Удаляет шаблон отчета.
-   **Успешный ответ (200 OK):**
    ```json
    {
        "success": true,
        "message": "Шаблон отчета успешно удален."
    }
    ```
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`.
    -   `404 Not Found`: Если шаблон не найден.

### 2.6. Установка шаблона по умолчанию

-   **URL:** `/api/v1/admin/report-templates/{template_id}/set-default`
-   **Метод:** `POST`
-   **Описание:** Устанавливает указанный шаблон как шаблон по умолчанию для его типа отчета и текущей организации. Предыдущий шаблон по умолчанию (если был) перестает быть таковым.
-   **Тело запроса:** Пустое.
-   **Успешный ответ (200 OK):** Тело ответа содержит обновленный ресурс шаблона, у которого `is_default` теперь `true`.
-   **Ошибки:**
    -   `401 Unauthorized`, `403 Forbidden`.
    -   `404 Not Found`: Если шаблон не найден.

</rewritten_file> 