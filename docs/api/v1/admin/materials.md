# Документация API: Материалы (Admin Panel)

**Базовый путь:** `/api/v1/admin`

**Аутентификация:** Требуется JWT токен (`Bearer <token>`) в заголовке `Authorization`. Токен должен быть для `api_admin`.

**Авторизация:** Все эндпоинты требуют прав доступа к админ-панели (`can:access-admin-panel`). Предполагается наличие прав `can:manage-catalogs` или аналогичных для управления справочниками.

**Контекст организации:** Все запросы выполняются в контексте текущей организации пользователя (`Auth::user()->current_organization_id`), который определяется автоматически middleware.

---

## 1. Материалы (`/materials`)

Эти эндпоинты управляются контроллером `App\Http\Controllers\Api\V1\Admin\MaterialController`.

### 1.1. Получение списка материалов

*   **Эндпоинт:** `GET /materials`
*   **Метод контроллера:** `index`
*   **Описание:** Возвращает пагинированный список материалов для текущей организации с возможностью фильтрации.
*   **Параметры запроса (Query):**
    *   `search` (string, опционально): Строка для поиска по названию, коду, категории.
    *   `category` (string, опционально): Фильтр по категории.
    *   `is_active` (boolean, опционально): Фильтр по активности.
    *   `measurement_unit_id` (integer, опционально): Фильтр по ID единицы измерения.
    *   `sort_by` (string, опционально): Поле для сортировки (например, `name`, `code`, `created_at`, по умолчанию `name`).
    *   `sort_direction` (string, опционально): Направление сортировки (`asc` или `desc`, по умолчанию `asc`).
    *   `per_page` (integer, опционально): Количество записей на страницу (по умолчанию 15).
    *   `page` (integer, опционально): Номер страницы.
*   **Успешный ответ (200):** (Формат коллекции `MaterialResource`)
    ```json
    {
      "data": [ /* Массив объектов MaterialResource */ ],
      "links": { /* Ссылки пагинации */ }, 
      "meta": { /* Мета-информация пагинации */ }  
    }
    ```

### 1.2. Создание материала

*   **Эндпоинт:** `POST /materials`
*   **Метод контроллера:** `store`
*   **Описание:** Создает новый материал. Валидация выполняется соответствующим Request-классом (например, `StoreMaterialRequest`).
*   **Тело запроса (JSON):**
    *   `name` (string, обязательно): Название материала.
    *   `code` (string, опционально): Внутренний код/артикул.
    *   `measurement_unit_id` (integer, обязательно): ID единицы измерения.
    *   `description` (string, опционально): Описание.
    *   `category` (string, опционально): Категория материала.
    *   `default_price` (numeric, опционально): Цена по умолчанию.
    *   `additional_properties` (object, опционально): Дополнительные свойства (JSON).
    *   `is_active` (boolean, опционально, по умолчанию true): Флаг активности.
    *   `external_code` (string, опционально): Внешний код (СБИС/1С).
    *   `sbis_nomenclature_code` (string, опционально): Код номенклатуры СБИС.
    *   `sbis_unit_code` (string, опционально): Код единицы измерения СБИС.
    *   `consumption_rates` (object, опционально): Нормы списания (JSON вида `{ work_type_id: rate, ... }`).
    *   `accounting_account` (string, опционально): Счет бухгалтерского учета.
*   **Успешный ответ (201):**
    ```json
    {
      "data": { /* Объект MaterialResource созданного материала */ }
    }
    ```
*   **Ошибка валидации (422).**
*   **Ошибка сервера (500).**

### 1.3. Получение деталей материала

*   **Эндпоинт:** `GET /materials/{material}`
*   **Метод контроллера:** `show`
*   **Описание:** Возвращает детальную информацию по конкретному материалу.
*   **Параметры пути:**
    *   `{material}` (integer, обязательно): ID материала.
*   **Успешный ответ (200):**
    ```json
    {
      "data": { /* Объект MaterialResource */ }
    }
    ```
*   **Ошибка (404):** Если материал не найден.

### 1.4. Обновление материала

*   **Эндпоинт:** `PUT /materials/{material}`
*   **Метод контроллера:** `update`
*   **Описание:** Обновляет существующий материал. Валидация `UpdateMaterialRequest`.
*   **Параметры пути:**
    *   `{material}` (integer, обязательно): ID материала.
*   **Тело запроса (JSON):** (Аналогично созданию, но все поля опциональны)
*   **Успешный ответ (200):**
    ```json
    {
      "data": { /* Объект MaterialResource обновленного материала */ }
    }
    ```
*   **Ошибка валидации (422).**
*   **Ошибка (404):** Если материал не найден.
*   **Ошибка сервера (500).**

### 1.5. Удаление материала

*   **Эндпоинт:** `DELETE /materials/{material}`
*   **Метод контроллера:** `destroy`
*   **Описание:** Удаляет материал (мягкое удаление).
*   **Параметры пути:**
    *   `{material}` (integer, обязательно): ID материала.
*   **Успешный ответ (204):** No Content.
*   **Ошибка (404):** Если материал не найден.
*   **Ошибка сервера (500):** (например, если материал используется и его нельзя удалить).

### 1.6. Получение списка единиц измерения

*   **Эндпоинт:** `GET /materials/measurement-units`
*   **Метод контроллера:** `getMeasurementUnits`
*   **Описание:** Возвращает список всех доступных единиц измерения.
*   **Успешный ответ (200):**
    ```json
    {
      "data": [
        { "id": 1, "name": "шт", "code": "pc" },
        { "id": 2, "name": "кг", "code": "kg" },
        // ...
      ]
    }
    ```

### 1.7. Получение балансов материала по проектам

*   **Эндпоинт:** `GET /materials/{id}/balances`
*   **Метод контроллера:** `getMaterialBalances`
*   **Описание:** Возвращает остатки конкретного материала на разных проектах.
*   **Параметры пути:**
    *   `{id}` (integer, обязательно): ID материала.
*   **Успешный ответ (200):**
    ```json
    {
      "data": [
        {
          "project_id": 10,
          "project_name": "ЖК Лазурный",
          "balance": 150.50
        },
        {
          "project_id": 15,
          "project_name": "Офисный центр",
          "balance": 300.00
        }
        // ...
      ]
    }
    ```
*   **Ошибка (404):** Если материал не найден.

### 1.8. Импорт материалов из файла

*   **Эндпоинт:** `POST /materials/import`
*   **Метод контроллера:** `importMaterials`
*   **Описание:** Запускает процесс импорта материалов из файла (XLSX, CSV).
*   **Тело запроса (multipart/form-data):**
    *   `file` (file, обязательно): Файл с материалами.
    *   `format` (string, опционально): Формат файла/данных (если отличается от стандартного).
*   **Успешный ответ (200):**
    ```json
    {
      "success": true,
      "message": "Импорт материалов запущен.", 
      "job_id": "..." // ID фоновой задачи (если импорт асинхронный)
      // или статистика, если импорт синхронный
      // "stats": { "total": ..., "imported": ..., "updated": ..., "errors": [...] }
    }
    ```
*   **Ошибка валидации (422).**
*   **Ошибка сервера (500).**

### 1.9. Получение норм списания материала

*   **Эндпоинт:** `GET /materials/{id}/consumption-rates`
*   **Метод контроллера:** `getConsumptionRates`
*   **Описание:** Возвращает текущие нормы списания для материала по видам работ.
*   **Параметры пути:**
    *   `{id}` (integer, обязательно): ID материала.
*   **Успешный ответ (200):**
    ```json
    {
      "data": [
        {
          "work_type_id": 5,
          "work_type_name": "Штукатурка стен",
          "rate": 0.5,
          "unit": { "id": 3, "name": "м2" }
        },
        {
          "work_type_id": 8,
          "work_type_name": "Кладка кирпича",
          "rate": 1.2,
          "unit": { "id": 4, "name": "м3" }
        }
        // ...
      ]
    }
    ```
*   **Ошибка (404):** Если материал не найден.

### 1.10. Обновление норм списания материала

*   **Эндпоинт:** `PUT /materials/{id}/consumption-rates`
*   **Метод контроллера:** `updateConsumptionRates`
*   **Описание:** Обновляет или устанавливает нормы списания для материала.
*   **Параметры пути:**
    *   `{id}` (integer, обязательно): ID материала.
*   **Тело запроса (JSON):**
    ```json
    {
      "rates": {
        "5": 0.6,  // work_type_id: rate
        "8": 1.1,
        "10": 0.0   // Установка нуля или удаление?
      }
    }
    ```
*   **Успешный ответ (200):**
    ```json
    {
      "success": true,
      "message": "Нормы списания обновлены.",
      "data": { /* Объект MaterialResource с обновленными consumption_rates */ }
    }
    ```
*   **Ошибка валидации (422).**
*   **Ошибка (404):** Если материал не найден.
*   **Ошибка сервера (500).**

### 1.11. Валидация материала для интеграции

*   **Эндпоинт:** `GET /materials/{id}/validate-for-accounting`
*   **Метод контроллера:** `validateForAccounting`
*   **Описание:** Проверяет, заполнены ли у материала все необходимые поля для корректной интеграции с СБИС/1С.
*   **Параметры пути:**
    *   `{id}` (integer, обязательно): ID материала.
*   **Успешный ответ (200):**
    ```json
    {
      "is_valid": true, // или false
      "missing_fields": [] // Список недостающих полей, если is_valid = false
      // например: ["external_code", "accounting_account"]
    }
    ```
*   **Ошибка (404):** Если материал не найден.

---

### Формат объекта `MaterialResource` (Примерный)

```json
{
  "id": 1,
  "name": "Цемент М500",
  "code": "CEM-500",
  "measurement_unit_id": 2,
  "description": "Портландцемент марки 500",
  "category": "Сыпучие материалы",
  "default_price": 500.00,
  "additional_properties": { "color": "grey" },
  "is_active": true,
  "organization_id": 12,
  "external_code": "EXT-CEM-001",
  "sbis_nomenclature_code": "СБИС-НМ-123",
  "sbis_unit_code": "СБИС-ЕД-КГ",
  "consumption_rates": { 
    "5": 0.5, 
    "8": 1.2 
  },
  "accounting_account": "10.1",
  "accounting_data": null,
  "use_in_accounting_reports": true, // Поле из модели Material
  "created_at": "2023-01-15T10:00:00",
  "updated_at": "2023-05-20T12:30:00",
  // Связанные данные
  "measurement_unit": {
    "id": 2,
    "name": "кг",
    "code": "kg"
  }
}
``` 