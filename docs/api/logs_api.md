# API Документация: Просмотр Логов Операций

## Аутентификация

Все запросы к API логов требуют аутентификации администратора (JWT токен в заголовке `Authorization: Bearer <token>`) и наличия права `view-operation-logs`, которое проверяется через Gate в контроллере. Маршруты также защищены общими middleware для админ-панели (`auth:api_admin`, `jwt.auth`, `organization.context`, `can:access-admin-panel`).

## Общие параметры для всех эндпоинтов логов

Следующие query-параметры могут использоваться для пагинации и сортировки:

-   `page` (integer, опционально, default: 1): Номер страницы для пагинации.
-   `per_page` (integer, опционально, default: 15): Количество записей на странице (min: 1, max: 100 - *предположение, может отличаться*).
-   `sort_by` (string, опционально, default: `created_at`): Поле для сортировки.
    -   Для логов материалов: `created_at`, `usage_date`, `material_name`, `project_name`, `user_name`, `quantity`.
    -   Для логов работ: `created_at`, `completion_date`, `work_type_name`, `project_name`, `user_name`, `quantity`.
-   `sort_direction` (string, опционально, default: `desc`): Направление сортировки. Допустимые значения: `asc`, `desc`.

## Эндпоинты

### 1. Логи операций с материалами

-   **URL:** `/api/v1/admin/logs/material-usage`
-   **Метод:** `GET`
-   **Описание:** Возвращает пагинированный список логов операций с материалами (приемки, списания), совершенных прорабами в рамках текущей организации администратора.
-   **Параметры запроса (Query Parameters) для фильтрации:**
    -   `project_id` (integer, опционально): Фильтр по ID проекта.
    -   `material_id` (integer, опционально): Фильтр по ID материала.
    -   `user_id` (integer, опционально): Фильтр по ID пользователя (прораба), совершившего операцию.
    -   `date_from` (string, опционально, формат: `YYYY-MM-DD`): Начальная дата периода фильтрации (включая указанную дату).
    -   `date_to` (string, опционально, формат: `YYYY-MM-DD`): Конечная дата периода фильтрации (включая указанную дату).
    -   `operation_type` (string, опционально): Фильтр по типу операции. Допустимые значения:
        -   `receipt` (приемка)
        -   `write_off` (списание)
-   **Успешный ответ (200 OK):**
    ```json
    {
        "data": [
            {
                "id": 123,
                "operation_type": "receipt", // "receipt" или "write_off" - ПОЛЕ ДОЛЖНО БЫТЬ В МОДЕЛИ И РЕСУРСЕ
                "project_id": 1,
                "project_name": "Стройка ЖК 'Солнечный'",
                "material_id": 10,
                "material_name": "Цемент М500",
                "user_id": 5,
                "user_name": "Иванов Иван",
                "quantity": 100.50,
                "unit_symbol": "кг",
                "unit_price": 350.00,        // ОПЦИОНАЛЬНО: Цена за единицу (если есть в логе)
                "total_price": 35175.00,     // ОПЦИОНАЛЬНО: Общая стоимость (если есть в логе)
                "supplier_id": 7,            // ОПЦИОНАЛЬНО: ID поставщика (для приемки)
                "supplier_name": "ООО СтройСнаб", // ОПЦИОНАЛЬНО: Имя поставщика (для приемки)
                "document_number": "ТН-00123", // ОПЦИОНАЛЬНО: Номер документа (накладной, акта)
                "usage_date": "2024-07-15",  // Дата фактической операции
                "notes": "Приемка цемента для фундамента, партия #3",
                "created_at": "2024-07-15T10:30:00.000000Z" // Дата создания записи в системе
            }
            // ... другие записи
        ],
        "links": {
            "first": "/api/v1/admin/logs/material-usage?page=1",
            "last": "/api/v1/admin/logs/material-usage?page=5",
            "prev": null,
            "next": "/api/v1/admin/logs/material-usage?page=2"
        },
        "meta": {
            "current_page": 1,
            "from": 1,
            "last_page": 5,
            "links": [ /* ... */ ],
            "path": "/api/v1/admin/logs/material-usage",
            "per_page": 15,
            "to": 15,
            "total": 70
        }
    }
    ```
-   **Ошибки:**
    -   `401 Unauthorized`: Ошибка аутентификации.
    -   `403 Forbidden`: Нет прав `view-operation-logs`.
    -   `422 Unprocessable Entity`: Ошибки валидации параметров (например, неверный формат даты).
    -   `500 Internal Server Error`: Внутренняя ошибка сервера.

### 2. Логи выполненных работ

-   **URL:** `/api/v1/admin/logs/work-completion`
-   **Метод:** `GET`
-   **Описание:** Возвращает пагинированный список логов выполненных работ прорабами в рамках текущей организации администратора.
-   **Параметры запроса (Query Parameters) для фильтрации:**
    -   `project_id` (integer, опционально): Фильтр по ID проекта.
    -   `work_type_id` (integer, опционально): Фильтр по ID вида работ.
    -   `user_id` (integer, опционально): Фильтр по ID пользователя (прораба), выполнившего работу.
    -   `date_from` (string, опционально, формат: `YYYY-MM-DD`): Начальная дата периода фильтрации (по полю `completion_date`, включая указанную дату).
    -   `date_to` (string, опционально, формат: `YYYY-MM-DD`): Конечная дата периода фильтрации (по полю `completion_date`, включая указанную дату).
-   **Успешный ответ (200 OK):**
    ```json
    {
        "data": [
            {
                "id": 456,
                "project_id": 2,
                "project_name": "Ремонт Офисного Центра",
                "work_type_id": 25,
                "work_type_name": "Укладка плитки на пол",
                "user_id": 8,
                "user_name": "Петров Пётр",
                "quantity": 120.75,
                "unit_symbol": "м²",
                "unit_price": 800.00,       // ОПЦИОНАЛЬНО: Цена за единицу (если есть в логе)
                "total_price": 96600.00,    // ОПЦИОНАЛЬНО: Общая стоимость (если есть в логе)
                "completion_date": "2024-07-18", // Дата фактического выполнения работы
                "notes": "Укладка плитки в коридоре 1-го этажа",
                "created_at": "2024-07-18T17:45:12.000000Z" // Дата создания записи в системе
            }
            // ... другие записи
        ],
        "links": { /* ... */ },
        "meta": { /* ... */ }
    }
    ```
-   **Ошибки:**
    -   `401 Unauthorized`: Ошибка аутентификации.
    -   `403 Forbidden`: Нет прав `view-operation-logs`.
    -   `422 Unprocessable Entity`: Ошибки валидации параметров.
    -   `500 Internal Server Error`: Внутренняя ошибка сервера.

**Важные замечания для фронтенда:**

*   Поля, отмеченные как `ОПЦИОНАЛЬНО` в примерах ответа (такие как `unit_price`, `total_price`, `supplier_id`, `supplier_name`, `document_number` для логов материалов, и `unit_price`, `total_price` для логов работ), могут отсутствовать в ответе, если они не были записаны в лог или не добавлены в соответствующий API Resource на бэкенде. Фронтенду следует быть готовым к их отсутствию или значению `null`.
*   Поле `operation_type` в логах материалов критически важно для различения приходок и списаний. Убедитесь, что оно будет добавлено в `MaterialUsageLogResource`, если его там еще нет.
*   Для фильтрации по датам (`date_from`, `date_to`) рекомендуется использовать календарь для выбора дат.
*   Значения для фильтров `project_id`, `material_id`, `user_id`, `work_type_id` должны получаться из соответствующих справочников или списков, доступных администратору.
*   Реализация сортировки по связанным полям (например, `material_name`) зависит от того, как это реализовано в репозитории на бэкенде (обычно требует `JOIN` и разрешения неоднозначности имен колонок). Если сортировка по таким полям не работает, следует уточнить у бэкенд-разработчиков. По умолчанию сортировка идет по `created_at` лога. 