name: Update Monitoring Configuration

on:
  push:
    paths:
      - 'monitoring/**'
      - 'docker-compose.yml'
      - 'start-monitoring.sh'
      - 'stop-monitoring.sh'
    branches:
      - main
  workflow_dispatch:

jobs:
  update-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY }}

      - name: Backup Current Config
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±ÑÐºÐ°Ð¿Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
            tar -czf /tmp/monitoring-config-backup-\$(date +%Y%m%d-%H%M%S).tar.gz \
              monitoring/ docker-compose.yml 2>/dev/null || true"

      - name: Update Monitoring Files
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
            git fetch origin && \
            git checkout origin/main -- monitoring/ docker-compose.yml start-monitoring.sh stop-monitoring.sh && \
            chmod +x start-monitoring.sh stop-monitoring.sh"

      - name: Validate Configuration
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° docker-compose
            (command -v docker-compose >/dev/null && docker-compose config || docker compose config) >/dev/null && \
            echo 'Docker Compose ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°' && \
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Prometheus
            docker run --rm -v \$(pwd)/monitoring/prometheus:/tmp \
              dnanexus/promtool:2.9.2 check config /tmp/prometheus.yml && \
            echo 'Prometheus ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°'"

      - name: Graceful Restart Monitoring
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Prometheus Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
            if docker ps | grep -q prometheus; then \
              echo 'Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ½Ð°Ð¿ÑˆÐ¾Ñ‚Ð° Prometheus...' && \
              curl -X POST http://localhost:9090/api/v1/admin/tsdb/snapshot || true && \
              sleep 5; \
            fi && \
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
            echo 'ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹...' && \
            (command -v docker-compose >/dev/null && docker-compose down || docker compose down) && \
            sleep 10 && \
            ./start-monitoring.sh"

      - name: Verify Services
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²...' && \
            sleep 60 && \
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            services_ok=0 && \
            if curl -sf http://localhost:9090/-/healthy >/dev/null; then \
              echo 'âœ… Prometheus Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' && \
              services_ok=\$((services_ok + 1)); \
            else \
              echo 'âŒ Prometheus Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'; \
            fi && \
            if curl -sf http://localhost:3000/api/health >/dev/null; then \
              echo 'âœ… Grafana Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' && \
              services_ok=\$((services_ok + 1)); \
            else \
              echo 'âŒ Grafana Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°'; \
            fi && \
            if curl -sf http://localhost:3100/ready >/dev/null; then \
              echo 'âœ… Loki Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' && \
              services_ok=\$((services_ok + 1)); \
            else \
              echo 'âŒ Loki Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'; \
            fi && \
            if curl -sf http://localhost:9100/metrics >/dev/null; then \
              echo 'âœ… Node Exporter Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' && \
              services_ok=\$((services_ok + 1)); \
            else \
              echo 'âŒ Node Exporter Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½'; \
            fi && \
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ
            if [ \$services_ok -eq 4 ]; then \
              echo 'ðŸŽ‰ Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚'; \
            else \
              echo 'âš ï¸ ÐÐµ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¸ÑÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾' && \
              exit 1; \
            fi"

      - name: Rollback on Failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            echo 'ðŸ”„ ÐžÑ‚ÐºÐ°Ñ‚ Ðº Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸...' && \
            # ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð±ÑÐºÐ°Ð¿Ð°
            latest_backup=\$(ls -t /tmp/monitoring-config-backup-*.tar.gz 2>/dev/null | head -1) && \
            if [ -n \"\$latest_backup\" ]; then \
              echo \"Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· \$latest_backup\" && \
              tar -xzf \"\$latest_backup\" && \
              (command -v docker-compose >/dev/null && docker-compose down || docker compose down) && \
              sleep 10 && \
              ./start-monitoring.sh && \
              echo 'ÐžÑ‚ÐºÐ°Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½'; \
            else \
              echo 'Ð‘ÑÐºÐ°Ð¿ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸' && \
              ./start-monitoring.sh; \
            fi"

      - name: Cleanup Old Backups
        if: always()
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð² (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
            find /tmp -name 'monitoring-config-backup-*.tar.gz' -mtime +30 -delete 2>/dev/null || true"