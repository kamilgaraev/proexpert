name: Monitoring Health Check

concurrency:
  group: monitoring-health
  cancel-in-progress: true

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Monitoring Services
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            if ! docker ps | grep -q prometheus; then \
              echo 'Prometheus –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥...' && \
              ./start-monitoring.sh; \
            fi && \
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
            services_down=0 && \
            if ! curl -sf http://localhost:9090/-/healthy >/dev/null; then \
              echo 'Prometheus –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' && \
              services_down=1; \
            fi && \
            if ! curl -sf http://localhost:3000/api/health >/dev/null; then \
              echo 'Grafana –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞' && \
              services_down=1; \
            fi && \
            if ! curl -sf http://localhost:3100/ready >/dev/null; then \
              echo 'Loki –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' && \
              services_down=1; \
            fi && \
            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
            if [ \$services_down -eq 1 ]; then \
              echo '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ—á–µ—á–Ω–æ...' && \
              (command -v docker-compose >/dev/null && docker-compose restart prometheus grafana loki || docker compose restart prometheus grafana loki) && \
              sleep 60 && \
              # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              if ! curl -sf http://localhost:9090/-/healthy >/dev/null; then \
                echo '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Prometheus –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è' && \
                exit 1; \
              fi; \
            else \
              echo '–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ'; \
            fi"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY }}

      - name: Check Disk Space
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
            disk_usage=\$(df / | tail -1 | awk '{print \$5}' | sed 's/%//') && \
            if [ \$disk_usage -gt 85 ]; then \
              echo '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ \${disk_usage}%' && \
              # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ Docker
              docker system prune -f --volumes && \
              # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ Laravel
              find /var/www/prohelper/storage/logs -name '*.log' -mtime +7 -delete; \
            fi"

      - name: Backup Monitoring Config
        run: |
          ssh -o StrictHostKeyChecking=no root@89.111.153.146 "\
            cd /var/www/prohelper && \
            # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            tar -czf /tmp/monitoring-backup-\$(date +%Y%m%d).tar.gz \
              monitoring/ docker-compose.yml start-monitoring.sh stop-monitoring.sh && \
            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –±—ç–∫–∞–ø–æ–≤
            find /tmp -name 'monitoring-backup-*.tar.gz' -mtime +7 -delete"

      - name: Send Status Notification
        if: failure()
        run: |
          echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Slack/Telegram
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –Ω–∞ –ø—Ä–æ–¥–µ!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}