name: Update Grafana Dashboard

on:
  push:
    branches: [main, master]
    paths:
      - 'monitoring/grafana/dashboards/**'
      - 'monitoring/prometheus/**'

jobs:
  update-monitoring:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy monitoring configs
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/prohelper
            git pull origin main
            
            # Restart Grafana to reload dashboards
            docker-compose restart grafana
            
            # Restart Prometheus if config changed
            if git diff --name-only HEAD~1 HEAD | grep -q "monitoring/prometheus/"; then
              docker-compose restart prometheus
            fi
            
            # Wait for services to start
            sleep 15
            
            # Import Grafana dashboards using curl
            echo "Importing Grafana dashboards..."
            for dashboard in monitoring/grafana/dashboards/*.json; do
              if [ -f "$dashboard" ]; then
                echo "Importing $(basename "$dashboard")..."
                curl -X POST \
                  -H "Content-Type: application/json" \
                  -u "admin:admin123" \
                  -d @"$dashboard" \
                  http://localhost:3000/api/dashboards/db || echo "Failed to import $(basename "$dashboard")"
              fi
            done
            
            echo "Dashboard import completed"
            echo "Monitoring configuration update completed"