name: Deploy to Production

concurrency:
  group: prod-deploy
  cancel-in-progress: false

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY}}



      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install NPM deps & build docs
        run: |
          npm ci --silent
          npm run docs:build

      - name: Deploy via SSH (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          timeout: 300s
          command_timeout: 180s
          script: |
            set -e # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            cd /var/www/prohelper
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Git safe.directory Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¾Ñ‚ root
            git config --global --add safe.directory /var/www/prohelper
            git config --global --add safe.directory '*'
            
            git reset --hard HEAD
            git clean -fd -e public/docs -e public/docs/**
            git fetch --all --prune
            
            # Ð’Ñ…Ð¾Ð´Ð¸Ð¼ Ð² Ñ€ÐµÐ¶Ð¸Ð¼ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°
            php artisan down || true
            
            git reset --hard origin/main
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (Ð±ÐµÐ· ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ vendor)
            # --no-dev: Ð½Ðµ ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ dev-Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð½Ð° Ð¿Ñ€Ð¾Ð´Ðµ
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            
            # ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸ÐºÐ° (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº "file not found")
            composer dump-autoload --optimize
            
            php artisan storage:link || true
            if [ ! -f /usr/local/bin/rr ]; then vendor/bin/rr get-binary --location=/usr/local/bin --no-config --stability=stable; fi
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð¡Ð•ÐšÐ¦Ð˜Ð¯: Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¾Ñ‚ÐºÐ°Ñ‚Ð¾Ð¼
            echo "ðŸ”„ Running safe migrations with automatic rollback..."
            php artisan migrate:safe --force
            echo "âœ… Migrations completed successfully"
            
            # Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            echo "ðŸ”„ Scanning modules..."
            php artisan modules:scan --clear-cache
            echo "âœ… Modules scan completed successfully"
            
            # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ: ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ñ‡Ð¸ÑÑ‚Ð¸Ð¼, Ð¿Ð¾Ñ‚Ð¾Ð¼ ÐºÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼
            echo "ðŸ”„ Optimizing application..."
            php artisan optimize:clear
            php artisan optimize
            echo "âœ… Optimization completed successfully"
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ (RoadRunner/Octane)
            echo "ðŸ”„ Reloading Application Server..."
            php artisan octane:reload || sudo systemctl reload prohelper-octane || sudo systemctl restart prohelper-octane || true
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Horizon
            echo "ðŸ”„ Restarting Horizon..."
            php artisan horizon:terminate || true
            echo "âœ… Horizon restarted"
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº queue workers (ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑ‰Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð²Ð½Ðµ Horizon)
            echo "ðŸ”„ Restarting queue workers..."
            supervisorctl restart laravel-worker:* || true
            echo "âœ… Queue workers restarted"
            
            # Ð’Ñ‹Ñ…Ð¾Ð´ Ð¸Ð· Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ (ÑÐ°Ð¹Ñ‚ ÑÐ½Ð¾Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)
            php artisan up || true

      - name: Copy docs to server (appleboy)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          source: public/docs/*
          target: /var/www/prohelper/public/docs/
          strip_components: 2

      - name: Verify and fix docs structure (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          timeout: 60s
          command_timeout: 30s
          script: |
            cd /var/www/prohelper
            echo "Checking docs files structure..."
            ls -la public/docs/
            
            # Ensure all required directories exist
            mkdir -p public/docs/admin public/docs/lk public/docs/mobile public/docs/landing_admin
            
            # Copy HTML files to correct locations if they exist
            if [ -f "public/docs/admin_api.html" ]; then
              cp public/docs/admin_api.html public/docs/admin/index.html
              echo "âœ… Copied admin_api.html"
            else
              echo "âŒ Missing admin_api.html"
            fi
            
            if [ -f "public/docs/mobile_api.html" ]; then
              cp public/docs/mobile_api.html public/docs/mobile/index.html
              echo "âœ… Copied mobile_api.html"
            else
              echo "âŒ Missing mobile_api.html"
            fi
            
            if [ -f "public/docs/lk_api.html" ]; then
              cp public/docs/lk_api.html public/docs/lk/index.html
              echo "âœ… Copied lk_api.html"
            else
              echo "âŒ Missing lk_api.html"
            fi
            
            if [ -f "public/docs/landing_admin_api.html" ]; then
              cp public/docs/landing_admin_api.html public/docs/landing_admin/index.html
              echo "âœ… Copied landing_admin_api.html"
            else
              echo "âŒ Missing landing_admin_api.html"
            fi
            
            # Set correct permissions
            chown -R www-data:www-data public/docs/
            chmod -R 755 public/docs/
            
            echo "Final docs structure:"
            ls -la public/docs/*/index.html 2>/dev/null || echo "Some index.html files missing"

      - name: Setup Monitoring (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          timeout: 120s
          command_timeout: 90s
          script: |
            cd /var/www/prohelper
            mkdir -p storage/logs/{api,telemetry}
            chmod -R 777 storage/logs/
            if ! docker ps | grep -q prometheus; then
              echo 'Starting monitoring stack...'
              chmod +x start-monitoring.sh
              ./start-monitoring.sh
            else
              echo 'Monitoring stack already running, restarting services...'
              (command -v docker-compose >/dev/null && docker-compose restart prometheus grafana || docker compose restart prometheus grafana)
            fi

      - name: Update Monitoring Configuration and Notify (appleboy)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          timeout: 120s
          command_timeout: 90s
          script: |
            cd /var/www/prohelper
            chmod +x start-monitoring.sh stop-monitoring.sh
            mkdir -p /var/lock
            flock -n /var/lock/prohelper-monitoring.lock -c '
              (docker ps -aq --filter name=^promtail$ | xargs -r docker stop) || true &&
              docker rm -f promtail 2>/dev/null || true &&
              if command -v docker-compose >/dev/null; then
                docker-compose up -d --remove-orphans --force-recreate prometheus grafana loki promtail node-exporter;
              else
                docker compose up -d --remove-orphans --force-recreate prometheus grafana loki promtail node-exporter;
              fi' || true
            sleep 3
            curl -X POST http://localhost:9090/api/v1/admin/tsdb/snapshot || true
            echo '{"timestamp":"'$(date -Iseconds)'","event":"deployment","version":"${{ github.sha }}","branch":"${{ github.ref_name }}"}' >> storage/logs/api/deployment.log