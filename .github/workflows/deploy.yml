name: Deploy to Production

concurrency:
  group: prod-deploy
  cancel-in-progress: true

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY}}



      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install NPM deps & build docs
        run: |
          npm ci --silent
          npm run docs:build

      - name: Deploy via SSH (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          script: |
            set -e # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            cd /var/www/prohelper
            git reset --hard HEAD
            git clean -fd -e public/docs -e public/docs/**
            git fetch --all --prune
            git reset --hard origin/main
            php artisan down || true
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan optimize:clear || true
            php artisan storage:link || true
            if [ ! -f /usr/local/bin/rr ]; then vendor/bin/rr get-binary --location=/usr/local/bin --no-config --stability=stable; fi
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð¡Ð•ÐšÐ¦Ð˜Ð¯: Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
            echo "ðŸ”„ Running migrations..."
            php artisan migrate --force
            echo "âœ… Migrations completed successfully"
            
            # Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            echo "ðŸ”„ Scanning modules..."
            php artisan modules:scan --clear-cache
            echo "âœ… Modules scan completed successfully"
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
            echo "ðŸ”„ Clearing module access cache..."
            php artisan cache:clear
            echo "âœ… Module cache cleared successfully"
            
            php artisan route:clear || true
            php artisan config:clear || true
            php artisan view:clear || true
            php artisan route:cache
            php artisan config:cache
            php artisan view:cache
            php artisan up || true
            php artisan octane:reload || sudo systemctl reload prohelper-octane || sudo systemctl restart prohelper-octane

      - name: Copy docs to server (appleboy)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          source: public/docs/*
          target: /var/www/prohelper/public/docs/
          strip_components: 2

      - name: Verify and fix docs structure (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          script: |
            cd /var/www/prohelper
            echo "Checking docs files structure..."
            ls -la public/docs/
            
            # Ensure all required directories exist
            mkdir -p public/docs/admin public/docs/lk public/docs/mobile public/docs/landing_admin
            
            # Copy HTML files to correct locations if they exist
            if [ -f "public/docs/admin_api.html" ]; then
              cp public/docs/admin_api.html public/docs/admin/index.html
              echo "âœ… Copied admin_api.html"
            else
              echo "âŒ Missing admin_api.html"
            fi
            
            if [ -f "public/docs/mobile_api.html" ]; then
              cp public/docs/mobile_api.html public/docs/mobile/index.html
              echo "âœ… Copied mobile_api.html"
            else
              echo "âŒ Missing mobile_api.html"
            fi
            
            if [ -f "public/docs/lk_api.html" ]; then
              cp public/docs/lk_api.html public/docs/lk/index.html
              echo "âœ… Copied lk_api.html"
            else
              echo "âŒ Missing lk_api.html"
            fi
            
            if [ -f "public/docs/landing_admin_api.html" ]; then
              cp public/docs/landing_admin_api.html public/docs/landing_admin/index.html
              echo "âœ… Copied landing_admin_api.html"
            else
              echo "âŒ Missing landing_admin_api.html"
            fi
            
            # Set correct permissions
            chown -R www-data:www-data public/docs/
            chmod -R 755 public/docs/
            
            echo "Final docs structure:"
            ls -la public/docs/*/index.html 2>/dev/null || echo "Some index.html files missing"

      - name: Setup Monitoring (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          script: |
            cd /var/www/prohelper
            mkdir -p storage/logs/{api,telemetry}
            chmod -R 777 storage/logs/
            if ! docker ps | grep -q prometheus; then
              echo 'Starting monitoring stack...'
              chmod +x start-monitoring.sh
              ./start-monitoring.sh
            else
              echo 'Monitoring stack already running, restarting services...'
              (command -v docker-compose >/dev/null && docker-compose restart prometheus grafana || docker compose restart prometheus grafana)
            fi

      - name: Health Check (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
        
          script: |
            cd /var/www/prohelper
            sleep 30
            (curl -fsS http://localhost/up || curl -kfsS https://localhost/up || echo 'App health check failed')
            curl -fsS http://localhost:9090/-/healthy || echo 'Prometheus health check failed'
            curl -fsS http://localhost:3000/api/health || echo 'Grafana health check failed'
            curl -fsS http://localhost:3100/ready || echo 'Loki health check failed'
            (curl -fsS http://localhost/metrics || curl -kfsS https://localhost/metrics || echo 'Metrics endpoint check failed')

      - name: Update Monitoring Configuration (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          script: |
            cd /var/www/prohelper
            chmod +x start-monitoring.sh stop-monitoring.sh
            mkdir -p /var/lock
            flock -n /var/lock/prohelper-monitoring.lock -c '
              (docker ps -aq --filter name=^promtail$ | xargs -r docker stop) || true &&
              docker rm -f promtail 2>/dev/null || true &&
              if command -v docker-compose >/dev/null; then
                docker-compose up -d --remove-orphans --force-recreate prometheus grafana loki promtail node-exporter;
              else
                docker compose up -d --remove-orphans --force-recreate prometheus grafana loki promtail node-exporter;
              fi'

      - name: Notify Monitoring (appleboy)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 89.169.44.117
          username: root
          key: ${{ secrets.DEPLOY }}
          script: |
            cd /var/www/prohelper
            curl -X POST http://localhost:9090/api/v1/admin/tsdb/snapshot || true
            echo '{"timestamp":"'$(date -Iseconds)'","event":"deployment","version":"${{ github.sha }}","branch":"${{ github.ref_name }}"}' >> storage/logs/api/deployment.log