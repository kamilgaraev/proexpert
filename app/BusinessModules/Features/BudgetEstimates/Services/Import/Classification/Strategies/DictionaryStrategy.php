<?php

namespace App\BusinessModules\Features\BudgetEstimates\Services\Import\Classification\Strategies;

use App\BusinessModules\Features\BudgetEstimates\Contracts\ClassificationStrategyInterface;
use App\BusinessModules\Features\BudgetEstimates\DTOs\ClassificationResult;

class DictionaryStrategy implements ClassificationStrategyInterface
{
    private array $patterns = [
        'material' => [
            'МАТ', 'материал', 'смеси', 'смесь', 'бетон', 'раствор', 'пленк', 'пленоч',
            'вода', 'щебен', 'песок', 'песч', 'цемент', 'арматур', 'проволок', 'сталь',
            'металл', 'краск', 'грунт', 'эмаль', 'лак', 'олиф', 'кирпич', 'блок',
            'панел', 'плит', 'доск', 'брус', 'фанер', 'гипсокартон', 'ГКЛ', 'ГВЛ',
            'изол', 'утеплит', 'минерал', 'пенопласт', 'пенополистирол', 'керамзит',
            'гравий', 'известь', 'гипс', 'шпаклев', 'штукатур', 'клей', 'мастик',
            'герметик', 'битум', 'рубероид', 'гидроизол', 'теплоизол', 'стеклоткан',
            'стекловат', 'минват', 'сетк', 'труб', 'трубопровод', 'фитинг', 'крепеж',
            'метиз', 'болт', 'гайк', 'шуруп', 'саморез', 'анкер', 'дюбел', 'гвозд',
            'заклеп', 'электрод', 'кабел', 'провод', 'шнур', 'лампа', 'светильник',
            'выключател', 'розетк', 'короб', 'гофр', 'линолеум', 'ламинат', 'паркет',
            'плитк', 'керамогранит', 'обои', 'стекло', 'зеркал', 'окн', 'двер',
            'дверн', 'ворот', 'калитк', 'засов', 'замок', 'ручк', 'петл', 'навес',
            'желоб', 'водосток', 'канализац', 'коллектор', 'люк', 'решетк', 'сантехник',
            'ванн', 'унитаз', 'раковин', 'смесител', 'кран', 'вентил', 'задвижк',
            'засыпк', 'почв'
        ],
        'equipment' => [
            'МР', 'ЭМ', 'машин', 'механизм', 'кран', 'автокран', 'башенный кран',
            'трактор', 'экскаватор', 'бульдозер', 'автомобил', 'самосвал', 'грузовик',
            'компрессор', 'вибратор', 'вибропло', 'вибротрамбовк', 'погрузчик',
            'фронтальн', 'трамбовк', 'катк', 'автогрейдер', 'скрепер', 'гидромолот',
            'перфоратор', 'отбойн', 'бетоносмесител', 'бетононасос', 'бетоноукладчик',
            'растворосмесител', 'растворонасос', 'штукатурн', 'малярн', 'сварочн',
            'аппарат', 'агрегат', 'установк', 'станок', 'станци', 'генератор',
            'трансформатор', 'подстанци', 'лебедк', 'тал', 'домкрат', 'подъемник',
            'вышк', 'люльк', 'леса', 'подмост', 'лесторн', 'опалубк', 'форм', 'щит',
            'стойк', 'балк', 'ригел', 'насос', 'мотопомп', 'электронасос', 'пескоструй',
            'дробеструй', 'пескомет', 'штроборез', 'резч', 'пилорам', 'электропил',
            'болгарк', 'дрель', 'шлифовальн', 'полировальн', 'фрезеровальн', 'токарн',
            'сверлильн', 'электроды', 'эксплуатаци', 'транспорт', 'перевозк',
            'автосамосвал', 'авточас', 'маш.-час', 'машино-час', 'час работы'
        ],
        'labor' => [
            'ОТм', 'ЭТм', 'ТЗ', 'ТЗм', 'ТЗп', 'ФОТ', 'зарплат', 'заработн',
            'оплат труд', 'разряд', 'средний разряд', 'машинист', 'рабочий',
            'рабочих', 'бригад', 'звено', 'монтажник', 'электрик', 'электромонтаж',
            'сварщик', 'слесар', 'плотник', 'столяр', 'каменщик', 'штукатур', 'маляр',
            'бетонщик', 'арматурщик', 'водитель', 'крановщик', 'сантехник',
            'изолировщик', 'кровельщик', 'отделочник', 'облицовщик', 'паркетчик',
            'стекольщик', 'такелажник', 'грузчик', 'подсобн', 'чел.-час',
            'человеко-час', 'чел-час', 'трудозатрат', 'затраты труда', 'персонал',
            'оплата труда рабочих', 'оплата труда машинист'
        ],
        'summary' => [
            'Итого', 'ИТОГО', 'Всего', 'ВСЕГО', 'Сумма', 'СУММА', 'накладн', 'НР',
            'СП', 'прибыль', 'сметная прибыль', 'сметн прибыл', 'НДС', 'н.д.с',
            'налог', 'резерв', 'резерв средств', 'непредвиденн', 'коэффициент',
            'коэфф', 'к-т', 'индекс', 'поправк', 'пересчет', 'лимит', 'базисн',
            'текущ', 'уровне цен', 'стоимость по смете', 'стоимость всего',
            'сметная стоимость', 'строительн работ', 'монтажн работ', 'прямые затрат',
            'прямых затрат', 'затраты труда', 'трудоемкост', 'материал всего',
            'машин всего', 'оборудован', 'прочие', 
            'объект', 'локальн', 'объектн', 'сводн', 'итого по', 'всего по',
            'стоимость', 'общая', 'общей'
        ],
        'section' => [
            'Раздел', 'РАЗДЕЛ', 'Глава', 'ГЛАВА', 'Подраздел', 'ПОДРАЗДЕЛ',
            'Этап', 'ЭТАП', 'Блок', 'Корпус', 'Здание'
        ]
    ];

    public function classify(string $code, string $name, ?string $unit = null, ?float $price = null): ?ClassificationResult
    {
        $text = trim($code . ' ' . $name);
        
        foreach ($this->patterns as $type => $keywords) {
            foreach ($keywords as $keyword) {
                if (mb_stripos($text, $keyword) !== false) {
                    // Рассчитываем confidence в зависимости от позиции и длины совпадения
                    $confidence = $this->calculateConfidence($text, $keyword);
                    
                    return new ClassificationResult($type, $confidence, 'dictionary');
                }
            }
        }

        return null;
    }

    public function classifyBatch(array $items): array
    {
        $results = [];
        foreach ($items as $index => $item) {
            $code = $item['code'] ?? '';
            $name = $item['name'] ?? '';
            $unit = $item['unit'] ?? null;
            $price = $item['price'] ?? null;
            
            $result = $this->classify($code, $name, $unit, $price);
            if ($result) {
                $results[$index] = $result;
            }
        }
        return $results;
    }

    private function calculateConfidence(string $text, string $keyword): float
    {
        $text = mb_strtolower($text);
        $keyword = mb_strtolower($keyword);
        $pos = mb_strpos($text, $keyword);
        
        // Если совпадение в начале строки - выше confidence
        if ($pos === 0) {
            return 0.8;
        }
        
        // Если совпадение в первой трети строки
        if ($pos < mb_strlen($text) / 3) {
            return 0.7;
        }
        
        return 0.6;
    }

    public function getName(): string
    {
        return 'dictionary';
    }
}
