<?php

namespace App\BusinessModules\Features\BudgetEstimates\Services\Import;

class EstimateItemTypeDetector
{
    private array $materialPatterns = [
        'ะะะข',
        'ะผะฐัะตัะธะฐะป',
        'ัะผะตัะธ',
        'ัะผะตัั',
        'ะฑะตัะพะฝ',
        'ัะฐััะฒะพั',
        'ะฟะปะตะฝะบ',
        'ะฟะปะตะฝะพั',
        'ะฒะพะดะฐ',
        'ัะตะฑะตะฝ',
        'ะฟะตัะพะบ',
        'ะฟะตัั',
        'ัะตะผะตะฝั',
        'ะฐัะผะฐััั',
        'ะฟัะพะฒะพะปะพะบ',
        'ััะฐะปั',
        'ะผะตัะฐะปะป',
        'ะบัะฐัะบ',
        'ะณััะฝั',
        'ัะผะฐะปั',
        'ะปะฐะบ',
        'ะพะปะธั',
        'ะบะธัะฟะธั',
        'ะฑะปะพะบ',
        'ะฟะฐะฝะตะป',
        'ะฟะปะธั',
        'ะดะพัะบ',
        'ะฑััั',
        'ัะฐะฝะตั',
        'ะณะธะฟัะพะบะฐััะพะฝ',
        'ะะะ',
        'ะะะ',
        'ะธะทะพะป',
        'ััะตะฟะปะธั',
        'ะผะธะฝะตัะฐะป',
        'ะฟะตะฝะพะฟะปะฐัั',
        'ะฟะตะฝะพะฟะพะปะธััะธัะพะป',
        'ะบะตัะฐะผะทะธั',
        'ะณัะฐะฒะธะน',
        'ะธะทะฒะตััั',
        'ะณะธะฟั',
        'ัะฟะฐะบะปะตะฒ',
        'ัััะบะฐััั',
        'ะบะปะตะน',
        'ะผะฐััะธะบ',
        'ะณะตัะผะตัะธะบ',
        'ะฑะธััะผ',
        'ััะฑะตัะพะธะด',
        'ะณะธะดัะพะธะทะพะป',
        'ัะตะฟะปะพะธะทะพะป',
        'ััะตะบะปะพัะบะฐะฝ',
        'ััะตะบะปะพะฒะฐั',
        'ะผะธะฝะฒะฐั',
        'ัะตัะบ',
        'ัััะฑ',
        'ัััะฑะพะฟัะพะฒะพะด',
        'ัะธัะธะฝะณ',
        'ะบัะตะฟะตะถ',
        'ะผะตัะธะท',
        'ะฑะพะปั',
        'ะณะฐะนะบ',
        'ััััะฟ',
        'ัะฐะผะพัะตะท',
        'ะฐะฝะบะตั',
        'ะดัะฑะตะป',
        'ะณะฒะพะทะด',
        'ะทะฐะบะปะตะฟ',
        'ัะปะตะบััะพะด',
        'ะบะฐะฑะตะป',
        'ะฟัะพะฒะพะด',
        'ัะฝัั',
        'ะปะฐะผะฟะฐ',
        'ัะฒะตัะธะปัะฝะธะบ',
        'ะฒัะบะปััะฐัะตะป',
        'ัะพะทะตัะบ',
        'ะบะพัะพะฑ',
        'ะณะพัั',
        'ะปะธะฝะพะปะตัะผ',
        'ะปะฐะผะธะฝะฐั',
        'ะฟะฐัะบะตั',
        'ะฟะปะธัะบ',
        'ะบะตัะฐะผะพะณัะฐะฝะธั',
        'ะพะฑะพะธ',
        'ััะตะบะปะพ',
        'ะทะตัะบะฐะป',
        'ะพะบะฝ',
        'ะดะฒะตั',
        'ะดะฒะตัะฝ',
        'ะฒะพัะพั',
        'ะบะฐะปะธัะบ',
        'ะทะฐัะพะฒ',
        'ะทะฐะผะพะบ',
        'ัััะบ',
        'ะฟะตัะป',
        'ะฝะฐะฒะตั',
        'ะถะตะปะพะฑ',
        'ะฒะพะดะพััะพะบ',
        'ะบะฐะฝะฐะปะธะทะฐั',
        'ะบะพะปะปะตะบัะพั',
        'ะปัะบ',
        'ัะตัะตัะบ',
        'ัะฐะฝัะตัะฝะธะบ',
        'ะฒะฐะฝะฝ',
        'ัะฝะธัะฐะท',
        'ัะฐะบะพะฒะธะฝ',
        'ัะผะตัะธัะตะป',
        'ะบัะฐะฝ',
        'ะฒะตะฝัะธะป',
        'ะทะฐะดะฒะธะถะบ',
        'ะทะฐััะฟะบ',
        'ะณััะฝั',
        'ะฟะพัะฒ',
    ];

    private array $equipmentPatterns = [
        'ะะ',
        'ะญะ',
        'ะผะฐัะธะฝ',
        'ะผะตัะฐะฝะธะทะผ',
        'ะบัะฐะฝ',
        'ะฐะฒัะพะบัะฐะฝ',
        'ะฑะฐัะตะฝะฝัะน ะบัะฐะฝ',
        'ััะฐะบัะพั',
        'ัะบัะบะฐะฒะฐัะพั',
        'ะฑัะปัะดะพะทะตั',
        'ะฐะฒัะพะผะพะฑะธะป',
        'ัะฐะผะพัะฒะฐะป',
        'ะณััะทะพะฒะธะบ',
        'ะบะพะผะฟัะตััะพั',
        'ะฒะธะฑัะฐัะพั',
        'ะฒะธะฑัะพะฟะปะพ',
        'ะฒะธะฑัะพััะฐะผะฑะพะฒะบ',
        'ะฟะพะณััะทัะธะบ',
        'ััะพะฝัะฐะปัะฝ',
        'ััะฐะผะฑะพะฒะบ',
        'ะบะฐัะบ',
        'ะฐะฒัะพะณัะตะนะดะตั',
        'ัะบัะตะฟะตั',
        'ะณะธะดัะพะผะพะปะพั',
        'ะฟะตััะพัะฐัะพั',
        'ะพัะฑะพะนะฝ',
        'ะฑะตัะพะฝะพัะผะตัะธัะตะป',
        'ะฑะตัะพะฝะพะฝะฐัะพั',
        'ะฑะตัะพะฝะพัะบะปะฐะดัะธะบ',
        'ัะฐััะฒะพัะพัะผะตัะธัะตะป',
        'ัะฐััะฒะพัะพะฝะฐัะพั',
        'ัััะบะฐัััะฝ',
        'ะผะฐะปััะฝ',
        'ัะฒะฐัะพัะฝ',
        'ะฐะฟะฟะฐัะฐั',
        'ะฐะณัะตะณะฐั',
        'ัััะฐะฝะพะฒะบ',
        'ััะฐะฝะพะบ',
        'ััะฐะฝัะธ',
        'ะณะตะฝะตัะฐัะพั',
        'ััะฐะฝััะพัะผะฐัะพั',
        'ะฟะพะดััะฐะฝัะธ',
        'ะปะตะฑะตะดะบ',
        'ัะฐะป',
        'ะดะพะผะบัะฐั',
        'ะฟะพะดัะตะผะฝะธะบ',
        'ะฒััะบ',
        'ะปัะปัะบ',
        'ะปะตัะฐ',
        'ะฟะพะดะผะพัั',
        'ะปะตััะพัะฝ',
        'ะพะฟะฐะปัะฑะบ',
        'ัะพัะผ',
        'ัะธั',
        'ััะพะนะบ',
        'ะฑะฐะปะบ',
        'ัะธะณะตะป',
        'ะฝะฐัะพั',
        'ะผะพัะพะฟะพะผะฟ',
        'ัะปะตะบััะพะฝะฐัะพั',
        'ะฟะตัะบะพััััะน',
        'ะดัะพะฑะตััััะน',
        'ะฟะตัะบะพะผะตั',
        'ัััะพะฑะพัะตะท',
        'ัะตะทั',
        'ะฟะธะปะพัะฐะผ',
        'ัะปะตะบััะพะฟะธะป',
        'ะฑะพะปะณะฐัะบ',
        'ะดัะตะปั',
        'ัะปะธัะพะฒะฐะปัะฝ',
        'ะฟะพะปะธัะพะฒะฐะปัะฝ',
        'ััะตะทะตัะพะฒะฐะปัะฝ',
        'ัะพะบะฐัะฝ',
        'ัะฒะตัะปะธะปัะฝ',
        'ัะปะตะบััะพะดั',
        'ัะบัะฟะปัะฐัะฐัะธ',
        'ััะฐะฝัะฟะพัั',
        'ะฟะตัะตะฒะพะทะบ',
        'ะฐะฒัะพัะฐะผะพัะฒะฐะป',
        'ะฐะฒัะพัะฐั',
        'ะผะฐั.-ัะฐั',
        'ะผะฐัะธะฝะพ-ัะฐั',
        'ัะฐั ัะฐะฑะพัั',
    ];

    private array $laborPatterns = [
        'ะะขะผ',
        'ะญะขะผ',
        'ะขะ',
        'ะขะะผ',
        'ะขะะฟ',
        'ะคะะข',
        'ะทะฐัะฟะปะฐั',
        'ะทะฐัะฐะฑะพัะฝ',
        'ะพะฟะปะฐั ัััะด',
        'ัะฐะทััะด',
        'ััะตะดะฝะธะน ัะฐะทััะด',
        'ะผะฐัะธะฝะธัั',
        'ัะฐะฑะพัะธะน',
        'ัะฐะฑะพัะธั',
        'ะฑัะธะณะฐะด',
        'ะทะฒะตะฝะพ',
        'ะผะพะฝัะฐะถะฝะธะบ',
        'ัะปะตะบััะธะบ',
        'ัะปะตะบััะพะผะพะฝัะฐะถ',
        'ัะฒะฐััะธะบ',
        'ัะปะตัะฐั',
        'ะฟะปะพัะฝะธะบ',
        'ััะพะปัั',
        'ะบะฐะผะตะฝัะธะบ',
        'ัััะบะฐััั',
        'ะผะฐะปัั',
        'ะฑะตัะพะฝัะธะบ',
        'ะฐัะผะฐััััะธะบ',
        'ะฒะพะดะธัะตะปั',
        'ะบัะฐะฝะพะฒัะธะบ',
        'ัะฐะฝัะตัะฝะธะบ',
        'ะธะทะพะปะธัะพะฒัะธะบ',
        'ะบัะพะฒะตะปััะธะบ',
        'ะพัะดะตะปะพัะฝะธะบ',
        'ะพะฑะปะธัะพะฒัะธะบ',
        'ะฟะฐัะบะตััะธะบ',
        'ััะตะบะพะปััะธะบ',
        'ัะฐะบะตะปะฐะถะฝะธะบ',
        'ะณััะทัะธะบ',
        'ะฟะพะดัะพะฑะฝ',
        'ัะตะป.-ัะฐั',
        'ัะตะปะพะฒะตะบะพ-ัะฐั',
        'ัะตะป-ัะฐั',
        'ัััะดะพะทะฐััะฐั',
        'ะทะฐััะฐัั ัััะดะฐ',
        'ะฟะตััะพะฝะฐะป',
        'ะพะฟะปะฐัะฐ ัััะดะฐ ัะฐะฑะพัะธั',
        'ะพะฟะปะฐัะฐ ัััะดะฐ ะผะฐัะธะฝะธัั',
    ];

    private array $summaryPatterns = [
        'ะัะพะณะพ',
        'ะะขะะะ',
        'ะัะตะณะพ',
        'ะะกะะะ',
        'ะกัะผะผะฐ',
        'ะกะฃะะะ',
        'ะฝะฐะบะปะฐะดะฝ',
        'ะะ',
        'ะกะ',
        'ะฟัะธะฑัะปั',
        'ัะผะตัะฝะฐั ะฟัะธะฑัะปั',
        'ัะผะตัะฝ ะฟัะธะฑัะป',
        'ะะะก',
        'ะฝ.ะด.ั',
        'ะฝะฐะปะพะณ',
        'ัะตะทะตัะฒ',
        'ัะตะทะตัะฒ ััะตะดััะฒ',
        'ะฝะตะฟัะตะดะฒะธะดะตะฝะฝ',
        'ะบะพัััะธัะธะตะฝั',
        'ะบะพััั',
        'ะบ-ั',
        'ะธะฝะดะตะบั',
        'ะฟะพะฟัะฐะฒะบ',
        'ะฟะตัะตััะตั',
        'ะปะธะผะธั',
        'ะฑะฐะทะธัะฝ',
        'ัะตะบัั',
        'ััะพะฒะฝะต ัะตะฝ',
        'ััะพะธะผะพััั ะฟะพ ัะผะตัะต',
        'ััะพะธะผะพััั ะฒัะตะณะพ',
        'ัะผะตัะฝะฐั ััะพะธะผะพััั',
        'ัััะพะธัะตะปัะฝ ัะฐะฑะพั',
        'ะผะพะฝัะฐะถะฝ ัะฐะฑะพั',
        'ะฟััะผัะต ะทะฐััะฐั',
        'ะฟััะผัั ะทะฐััะฐั',
        'ะทะฐััะฐัั ัััะดะฐ',
        'ัััะดะพะตะผะบะพัั',
        'ะผะฐัะตัะธะฐะป ะฒัะตะณะพ',
        'ะผะฐัะธะฝ ะฒัะตะณะพ',
        'ะพะฑะพััะดะพะฒะฐะฝ',
        'ะฟัะพัะธะต',
        'ะฟะพะดัะฐะทะดะตะป',
        'ัะฐะทะดะตะป',
        'ะณะปะฐะฒะฐ',
        'ะพะฑัะตะบั',
        'ะปะพะบะฐะปัะฝ',
        'ะพะฑัะตะบัะฝ',
        'ัะฒะพะดะฝ',
        'ะธัะพะณะพ ะฟะพ',
        'ะฒัะตะณะพ ะฟะพ',
        'ััะพะธะผะพััั',
        'ะพะฑัะฐั',
        'ะพะฑัะตะน',
    ];

    public function detectType(?string $justification, string $name, ?string $code = null): string
    {
        $justificationUpper = mb_strtoupper($justification ?? '');
        $nameUpper = mb_strtoupper($name);
        $combinedText = trim(($code ?? '') . ' ' . ($justification ?? '') . ' ' . $name);
        
        if (preg_match('/^(ะะขะผ|ะญะขะผ|ะขะ|ะขะะผ|ะขะะฟ|ะคะะข)/ui', $justificationUpper)) {
            return 'labor';
        }
        
        if (preg_match('/^(ะะะข|ะะญะกะะผ|ะคะะะผ|ะขะะะผ)/ui', $justificationUpper)) {
            return 'material';
        }
        
        if (preg_match('/^(ะะ|ะญะ|ะะญะกะั|ะคะะั|ะขะะั)/ui', $justificationUpper)) {
            return 'equipment';
        }
        
        if ($this->matchesPatterns($combinedText, $this->laborPatterns)) {
            return 'labor';
        }
        
        if ($this->matchesPatterns($combinedText, $this->summaryPatterns)) {
            return 'summary';
        }
        
        if ($this->matchesPatterns($combinedText, $this->equipmentPatterns)) {
            return 'equipment';
        }
        
        if ($this->matchesPatterns($combinedText, $this->materialPatterns)) {
            return 'material';
        }
        
        if ($this->looksLikeWorkCode($justification)) {
            return 'work';
        }
        
        if ($this->hasNumericCode($code)) {
            return 'work';
        }
        
        return 'work';
    }

    private function matchesPatterns(string $text, array $patterns): bool
    {
        foreach ($patterns as $pattern) {
            if (mb_stripos($text, $pattern) !== false) {
                return true;
            }
        }
        
        return false;
    }

    private function looksLikeWorkCode(?string $code): bool
    {
        if (empty($code)) {
            return false;
        }
        
        if (preg_match('/^(ะคะะ|ะะญะกะ|ะขะะ|ะะญะกะะผ|ะะญะกะั|ะะญะกะะฟ|ะคะะะผ|ะคะะั|ะคะะะฟ)/ui', $code)) {
            return true;
        }
        
        if (preg_match('/^\d{1,2}-\d{1,2}-\d{1,3}-\d{1,2}/', $code)) {
            return true;
        }
        
        if (preg_match('/^[ะ-ะฏA-Z]{2,5}\d{2,3}-\d{1,4}/ui', $code)) {
            return true;
        }
        
        return false;
    }

    private function hasNumericCode(?string $code): bool
    {
        if (empty($code)) {
            return false;
        }
        
        return preg_match('/\d/', $code) === 1;
    }

    public function getTypeLabel(string $type): string
    {
        return match ($type) {
            'work' => 'ะะฐะฑะพัะฐ',
            'material' => 'ะะฐัะตัะธะฐะป',
            'equipment' => 'ะะฐัะธะฝั/ะะตัะฐะฝะธะทะผั',
            'labor' => 'ะขััะดะพะทะฐััะฐัั',
            'summary' => 'ะัะพะณะพะฒะฐั ัััะพะบะฐ',
            default => 'ะะตะธะทะฒะตััะฝะพ',
        };
    }

    public function getTypeIcon(string $type): string
    {
        return match ($type) {
            'work' => '๐ง',
            'material' => '๐ฆ',
            'equipment' => '๐',
            'labor' => '๐ท',
            'summary' => '๐',
            default => 'โ',
        };
    }
}

